<!DOCTYPE html>
 <html lang="en">
 <head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <!-- Updated Title -->
     <title>AI Tools Directory - The Ultimate AI Tool Directory</title>
     <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
     <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
     <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
     <style>
         @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

         html {
             scroll-behavior: smooth; /* Enable smooth scrolling for the whole page */
         }

         body {
             font-family: 'Inter', sans-serif;
             background-color: #f9fafb;
         }

         .gradient-text {
             background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
             -webkit-background-clip: text;
             background-clip: text;
             color: transparent;
         }

         .card-hover:hover {
             transform: translateY(-5px);
             box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.1);
         }

         .feature-card {
             transition: all 0.3s ease;
         }

         .feature-card:hover {
             transform: translateY(-5px);
         }

         .tool-card {
             transition: all 0.2s ease;
         }
         /* Add a base hidden style for filtering */
         .tool-card.hidden, .news-card.hidden {
            display: none;
         }


         .tool-card:hover {
             transform: translateY(-3px);
             box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
         }

         .news-card {
             transition: all 0.2s ease;
         }

         .news-card:hover {
             transform: translateY(-3px);
             box-shadow: 0 10px 15px rgba(0, 0, 0, 0.05);
         }

         .comparison-card {
             transition: all 0.3s ease;
         }

         .modal {
             display: none;
             position: fixed;
             z-index: 1000;
             left: 0;
             top: 0;
             width: 100%;
             height: 100%;
             overflow: auto;
             background-color: rgba(0,0,0,0.6); /* Darker background */
             backdrop-filter: blur(3px); /* Optional: blur background */
             animation: fadeIn 0.3s ease;
         }

         .modal-content {
             background-color: #fefefe;
             margin: 10% auto; /* Adjusted margin */
             padding: 25px; /* Increased padding */
             border: 1px solid #ddd; /* Softer border */
             width: 90%; /* Responsive width */
             max-width: 600px; /* Slightly wider for details */
             border-radius: 12px; /* More rounded corners */
             box-shadow: 0 5px 15px rgba(0,0,0,0.2);
             animation: slideIn 0.3s ease;
             max-height: 80vh; /* Limit height */
             overflow-y: auto; /* Allow scrolling within modal */
         }

         /* Specific width for auth forms */
         .modal-content.auth-modal {
            max-width: 500px;
         }


         .close {
             color: #aaa;
             float: right;
             font-size: 32px; /* Larger close button */
             line-height: 1;
             font-weight: bold;
             transition: color 0.2s ease;
             position: sticky; /* Make close button stick */
             top: 10px; /* Adjust position as needed */
             right: 15px;
             z-index: 1001; /* Ensure it's above content */
             cursor: pointer; /* Ensure cursor changes */
         }

         .close:hover,
         .close:focus {
             color: #333; /* Darker hover */
             text-decoration: none;
             cursor: pointer;
         }

         /* Modal Animations */
         @keyframes fadeIn {
             from {opacity: 0;}
             to {opacity: 1;}
         }

         @keyframes slideIn {
             from {transform: translateY(-30px); opacity: 0;}
             to {transform: translateY(0); opacity: 1;}
         }

         /* Active state for filter buttons */
         .filter-button-active {
             background-color: #4f46e5 !important; /* Use !important carefully */
             color: white !important;
             border-color: #4f46e5 !important;
         }
         .filter-button-inactive {
             background-color: white;
             border: 1px solid #d1d5db; /* gray-300 */
             color: #374151; /* gray-700 */
         }
         .filter-button-inactive:hover {
              background-color: #f9fafb; /* gray-50 */
         }

         /* Style for links within modal forms */
        .modal-form-link {
             cursor: pointer;
             color: #4f46e5; /* indigo-600 */
             font-weight: 500;
        }
        .modal-form-link:hover {
            text-decoration: underline;
        }

        /* Tailwind Prose styles for modal news content */
        .prose { color: #374151; /* gray-700 */ line-height: 1.65; }
        .prose :where(p):not(:where([class~="not-prose"], [class~="not-prose"] *)) { margin-top: 1.25em; margin-bottom: 1.25em; }
        .prose :where(h1,h2,h3,h4,h5,h6):not(:where([class~="not-prose"], [class~="not-prose"] *)) { color: #111827; /* gray-900 */ font-weight: 600; margin-top: 1.6em; margin-bottom: 0.6em; }
        .prose :where(h2):not(:where([class~="not-prose"], [class~="not-prose"] *)) { font-size: 1.25em; }
        .prose :where(h3):not(:where([class~="not-prose"], [class~="not-prose"] *)) { font-size: 1.125em; }
        .prose :where(a):not(:where([class~="not-prose"], [class~="not-prose"] *)) { color: #4f46e5; /* indigo-600 */ text-decoration: underline; font-weight: 500; }
        .prose :where(strong):not(:where([class~="not-prose"], [class~="not-prose"] *)) { color: #111827; /* gray-900 */ font-weight: 600; }
        .prose :where(ul):not(:where([class~="not-prose"], [class~="not-prose"] *)) { list-style-type: disc; margin-top: 1.25em; margin-bottom: 1.25em; padding-left: 1.625em; }
        .prose :where(li):not(:where([class~="not-prose"], [class~="not-prose"] *)) { margin-top: 0.5em; margin-bottom: 0.5em; }
        .prose :where(code):not(:where([class~="not-prose"], [class~="not-prose"] *)) { background-color: #e5e7eb; /* gray-200 */ padding: 0.2em 0.4em; margin: 0; font-size: 85%; border-radius: 3px; font-family: monospace; }

        /* START: Comparison Tray CSS */
        #comparisonTray.visible { display: block; transform: translateY(0); }
        .remove-compare-btn { background: none; border: none; cursor: pointer; padding: 0 2px; line-height: 1; }

        /* Comparison Tray Scrollbar */
        .scrollbar-thin { scrollbar-width: thin; scrollbar-color: #4b5563 #1f2937; }
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: #1f2937; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #4b5563; border-radius: 3px; }

        /* Mobile Comparison Table Sticky Header/Column */
        #comparisonResults .overflow-x-auto { position: relative; }
        @media (max-width: 768px) {
            #comparisonTable thead th { position: -webkit-sticky; position: sticky; top: 0; background-color: #f9fafb; z-index: 20; box-shadow: inset 0 -1px 0 #e5e7eb; }
            #comparisonTable tbody th,
            #comparisonTable tbody tr td:first-child { position: -webkit-sticky; position: sticky; left: 0; background-color: #ffffff; z-index: 10; box-shadow: inset -1px 0 0 #e5e7eb; }
            #comparisonTable thead th:first-child { left: 0; z-index: 30; }
            #comparisonTable { width: 100%; }
        }

        /* Comparison Table Highlight */
        #comparisonTable .bg-green-50 { background-color: #f0fdf4; }
        #comparisonTable .text-green-800 { color: #166534; }

        /* Shake Animation */
        @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); } 20%, 40%, 60%, 80% { transform: translateX(5px); } }
        #comparisonTray.shake { animation: shake 0.5s ease-in-out; }

        /* Star Rating Input */
        .star-rating-input label { margin-right: 2px; }
        .star-rating-input input:focus-visible + label i { outline: 2px solid #4f46e5; outline-offset: 1px; border-radius: 2px; }

        /* Favorite button visual states */
        .favorite-btn i { transition: transform 0.2s ease-in-out, color 0.2s ease-in-out; }
        .favorite-btn.favorited > i { color: #ef4444; transform: scale(1.1); }
        .favorite-btn:not(.favorited):hover > i { color: #f87171; }

        /* Basic input field style */
        .input-field{border:1px solid #d1d5db; border-radius: 0.375rem; padding: 0.5rem 0.75rem; width: 100%; outline:none; box-shadow:none;}
        .input-field:focus{border-color:#4f46e5; --tw-ring-color: #4f46e5; box-shadow: 0 0 0 1px var(--tw-ring-color); }
        .btn-primary { background-color: #4f46e5; color: white; padding: 0.5rem 1rem; border-radius: 0.375rem; font-weight: 500; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-primary:disabled { opacity: 0.6; cursor: not-allowed; }
        /* END: Comparison Tray CSS */

     </style>
 </head>
 <body class="antialiased"> <!-- Added antialiased for better font rendering -->
     <!-- Navigation -->
 <nav class="bg-white shadow-sm sticky top-0 z-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex">
                <!-- Logo/Title -->
                <div class="flex-shrink-0 flex items-center">
                    <span class="text-2xl font-bold gradient-text">AI Tools Directory</span>
                </div>
                <!-- Desktop Nav Links -->
                <div class="hidden sm:ml-6 sm:flex sm:space-x-8">
                    <a href="#home" class="border-indigo-500 text-gray-900 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium nav-link">Home</a>
                    <a href="#tools" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium nav-link">Tools</a>
                    <a href="#comparison" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium nav-link">Compare</a>
                    <a href="#news" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium nav-link">News</a>
                    <a href="#matchmaker" class="border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700 inline-flex items-center px-1 pt-1 border-b-2 text-sm font-medium nav-link">AI Matchmaker</a>
                </div>
            </div>

            <!-- Desktop Auth Area (Right Side) -->
            <div class="hidden sm:ml-6 sm:flex sm:items-center">
                <!-- Desktop Auth Status Container -->
                <div id="authStatusContainer" class="ml-3 relative flex items-center">
                    <!-- Initial placeholder button - JS will replace this innerHTML -->
                    <button id="signInBtnDesktopPlaceholder" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:opacity-90 transition-opacity">
                        Sign In / Sign Up
                    </button>
                </div>
            </div>

            <!-- Mobile Menu Button -->
            <div class="-mr-2 flex items-center sm:hidden">
              <button type="button" class="bg-white inline-flex items-center justify-center p-2 rounded-md text-gray-400 hover:text-gray-500 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-indigo-500" aria-controls="mobile-menu" aria-expanded="false" id="mobileMenuBtn">
                <span class="sr-only">Open main menu</span>
                <i class="fas fa-bars text-lg"></i> <!-- Hamburger icon -->
              </button>
            </div>
        </div>
    </div>

     <!-- Mobile menu, show/hide based on menu state. -->
     <div class="sm:hidden hidden" id="mobile-menu">
        <div class="pt-2 pb-3 space-y-1">
          <!-- Mobile nav links -->
          <a href="#home" class="block pl-3 pr-4 py-2 border-l-4 border-indigo-500 text-base font-medium text-indigo-700 bg-indigo-50 nav-link">Home</a>
          <a href="#tools" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 nav-link">Tools</a>
          <a href="#comparison" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 nav-link">Compare</a>
          <a href="#news" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 nav-link">News</a>
          <a href="#matchmaker" class="block pl-3 pr-4 py-2 border-l-4 border-transparent text-base font-medium text-gray-500 hover:bg-gray-50 hover:border-gray-300 hover:text-gray-700 nav-link">AI Matchmaker</a>
        </div>

        <!-- Mobile Auth Status Container -->
        <div id="authStatusContainerMobile" class="pt-4 pb-3 border-t border-gray-200 px-4">
            <!-- Initial placeholder button - JS will replace this innerHTML -->
            <button id="signInBtnMobilePlaceholder" class="w-full text-left block py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-md text-center border border-gray-300">
                Sign In / Sign Up
            </button>
        </div>
      </div>
</nav>
     <!-- Hero Section -->
     <section id="home" class="py-12 bg-white">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="lg:flex lg:items-center lg:justify-between">
                 <div class="lg:w-1/2">
                     <h1 class="text-4xl font-extrabold tracking-tight text-gray-900 sm:text-5xl md:text-6xl">
                         <span class="block">Find the perfect</span>
                         <span class="block gradient-text">AI tool for your needs</span>
                     </h1>
                     <p class="mt-3 max-w-md mx-auto text-lg text-gray-500 sm:text-xl md:mt-5 md:max-w-3xl">
                         The most comprehensive directory of AI tools with interactive comparisons, real-time news, and personalized recommendations.
                     </p>
                     <div class="mt-10 sm:flex">
                         <div class="rounded-md shadow">
                             <a href="#matchmaker" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 md:py-4 md:text-lg md:px-10 nav-link">
                                 Find Your AI Tool
                             </a>
                         </div>
                         <div class="mt-3 sm:mt-0 sm:ml-3">
                             <a href="#tools" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-indigo-600 bg-white hover:bg-gray-50 md:py-4 md:text-lg md:px-10 nav-link">
                                 Browse Directory
                             </a>
                         </div>
                     </div>
                 </div>
                 <div class="mt-10 lg:mt-0 lg:w-1/2">
                     <div class="relative">
                         <div class="absolute inset-0 bg-gradient-to-r from-blue-100 to-indigo-100 shadow-lg transform -skew-y-6 sm:skew-y-0 sm:-rotate-6 sm:rounded-3xl"></div>
                         <div class="relative bg-white p-6 sm:p-10 shadow-xl rounded-3xl">
                             <div class="flex items-center justify-between mb-8">
                                 <div>
                                     <h2 class="text-xl font-bold text-gray-900">Top Trending AI Tools</h2>
                                     <p class="text-sm text-gray-500">Updated hourly</p>
                                 </div>
                                 <div>
                                     <!-- Added ID for JS interaction -->
                                     <select id="heroCategorySelect" class="text-sm text-gray-500 border border-gray-300 rounded-md p-1 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                                         <option>All Categories</option>
                                         <option>Text Generation</option>
                                         <option>Image Generation</option>
                                         <option>Code Assistants</option>
                                         <option>Audio & Music</option>
                                     </select>
                                 </div>
                             </div>
                             <!-- Hero trending tools will remain static for now, not linked to API -->
                             <div class="space-y-4">
                                 <!-- Static trending tools list -->
                                 <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg bg-gray-50 tool-card">
                                     <div class="flex items-center">
                                         <div class="bg-blue-100 rounded-md p-2 mr-4"> <i class="fas fa-robot text-blue-500"></i> </div>
                                         <div> <h3 class="font-medium">Claude 3.7 Sonnet</h3> <p class="text-sm text-gray-500">Text & Reasoning</p> </div>
                                     </div>
                                     <div class="flex items-center"> <div class="text-sm font-medium text-gray-900 mr-2">4.9</div> <div class="flex items-center"> <i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i> </div> </div>
                                 </div>
                                 <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg bg-gray-50 tool-card">
                                     <div class="flex items-center"> <div class="bg-purple-100 rounded-md p-2 mr-4"> <i class="fas fa-palette text-purple-500"></i> </div> <div> <h3 class="font-medium">Midjourney v6.5</h3> <p class="text-sm text-gray-500">Image Generation</p> </div> </div>
                                     <div class="flex items-center"> <div class="text-sm font-medium text-gray-900 mr-2">4.8</div> <div class="flex items-center"> <i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star-half-alt text-yellow-400"></i> </div> </div>
                                 </div>
                                 <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg bg-gray-50 tool-card">
                                     <div class="flex items-center"> <div class="bg-green-100 rounded-md p-2 mr-4"> <i class="fas fa-code text-green-500"></i> </div> <div> <h3 class="font-medium">GitHub Copilot</h3> <p class="text-sm text-gray-500">Code Assistant</p> </div> </div>
                                     <div class="flex items-center"> <div class="text-sm font-medium text-gray-900 mr-2">4.7</div> <div class="flex items-center"> <i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star-half-alt text-yellow-400"></i> </div> </div>
                                 </div>
                                 <div class="flex items-center justify-between p-4 border border-gray-100 rounded-lg bg-gray-50 tool-card">
                                     <div class="flex items-center"> <div class="bg-yellow-100 rounded-md p-2 mr-4"> <i class="fas fa-music text-yellow-600"></i> </div> <div> <h3 class="font-medium">Suno AI</h3> <p class="text-sm text-gray-500">Music Generation</p> </div> </div>
                                     <div class="flex items-center"> <div class="text-sm font-medium text-gray-900 mr-2">4.6</div> <div class="flex items-center"> <i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star text-yellow-400"></i><i class="fas fa-star-half-alt text-yellow-400"></i> </div> </div>
                                 </div>
                             </div>
                             <div class="mt-6 text-center">
                                 <a href="#tools" class="text-indigo-600 hover:text-indigo-500 text-sm font-medium nav-link">
                                     View all tools <i class="fas fa-arrow-right ml-1"></i>
                                 </a>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
     </section>

     <!-- Stats Section -->
     <section class="bg-indigo-800 py-10">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="grid grid-cols-2 gap-4 md:grid-cols-4 text-center">
                 <!-- Stats remain static for now -->
                 <div class="bg-indigo-700 rounded-lg p-6">
                     <div class="text-4xl font-bold text-white" data-target="1250">0+</div>
                     <div class="text-indigo-200 mt-1">AI Tools</div>
                 </div>
                 <div class="bg-indigo-700 rounded-lg p-6">
                     <div class="text-4xl font-bold text-white" data-target="40">0+</div>
                     <div class="text-indigo-200 mt-1">Categories</div>
                 </div>
                 <div class="bg-indigo-700 rounded-lg p-6">
                     <div class="text-4xl font-bold text-white" data-target="25000">0+</div>
                     <div class="text-indigo-200 mt-1">User Reviews</div>
                 </div>
                 <div class="bg-indigo-700 rounded-lg p-6">
                     <div class="text-4xl font-bold text-white">Daily</div>
                     <div class="text-indigo-200 mt-1">Updates</div>
                 </div>
             </div>
         </div>
     </section>

     <!-- Features Section -->
     <section class="py-12 bg-gray-50">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <div class="text-center">
                 <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl"> Features that set us apart </h2>
                 <p class="mt-4 max-w-2xl mx-auto text-xl text-gray-500"> Discover AI tools like never before with our unique interactive features. </p>
             </div>
             <div class="mt-10">
                 <div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3">
                     <!-- Features remain static -->
                     <div class="bg-white rounded-lg shadow-md p-6 feature-card"> <div class="bg-blue-100 p-2 rounded-full w-12 h-12 flex items-center justify-center mb-4"> <i class="fas fa-exchange-alt text-blue-600 text-xl"></i> </div> <h3 class="text-lg font-medium text-gray-900">Dynamic Comparisons</h3> <p class="mt-2 text-gray-500"> Compare up to 4 AI tools side-by-side with interactive feature matrices and visual differentiators. </p> </div>
                     <div class="bg-white rounded-lg shadow-md p-6 feature-card"> <div class="bg-purple-100 p-2 rounded-full w-12 h-12 flex items-center justify-center mb-4"> <i class="fas fa-user-check text-purple-600 text-xl"></i> </div> <h3 class="text-lg font-medium text-gray-900">AI Matchmaker Quiz</h3> <p class="mt-2 text-gray-500"> Find your perfect AI tool match through our interactive questionnaire based on your needs and skills. </p> </div>
                     <div class="bg-white rounded-lg shadow-md p-6 feature-card"> <div class="bg-green-100 p-2 rounded-full w-12 h-12 flex items-center justify-center mb-4"> <i class="fas fa-newspaper text-green-600 text-xl"></i> </div> <h3 class="text-lg font-medium text-gray-900">Real-time AI News</h3> <p class="mt-2 text-gray-500"> Stay updated with curated news about AI advancements, new releases, and industry trends. </p> </div>
                     <div class="bg-white rounded-lg shadow-md p-6 feature-card"> <div class="bg-yellow-100 p-2 rounded-full w-12 h-12 flex items-center justify-center mb-4"> <i class="fas fa-chart-line text-yellow-600 text-xl"></i> </div> <h3 class="text-lg font-medium text-gray-900">Performance Benchmarks</h3> <p class="mt-2 text-gray-500"> View standardized comparison metrics for similar AI models to understand performance differences. </p> </div>
                     <div class="bg-white rounded-lg shadow-md p-6 feature-card"> <div class="bg-red-100 p-2 rounded-full w-12 h-12 flex items-center justify-center mb-4"> <i class="fas fa-tasks text-red-600 text-xl"></i> </div> <h3 class="text-lg font-medium text-gray-900">Use Case Scenarios</h3> <p class="mt-2 text-gray-500"> Interactive demos showing how different tools solve common problems in various industries. </p> </div>
                     <div class="bg-white rounded-lg shadow-md p-6 feature-card"> <div class="bg-indigo-100 p-2 rounded-full w-12 h-12 flex items-center justify-center mb-4"> <i class="fas fa-calendar-alt text-indigo-600 text-xl"></i> </div> <h3 class="text-lg font-medium text-gray-900">Release Calendar</h3> <p class="mt-2 text-gray-500"> Track upcoming AI tool releases and beta access opportunities all in one place. </p> </div>
                 </div>
             </div>
         </div>
     </section>

     <!-- Tools Directory Section -->
     <section id="tools" class="py-12 bg-white">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-8"> AI Tools Directory </h2>
             <!-- NEW Filter Controls Block -->
             <div class="mb-8 p-4 border rounded-lg bg-gray-50 space-y-4" id="toolFilterControls">
                 <!-- Row 1: Categories -->
                 <div class="flex flex-wrap items-center gap-2" id="toolFilterButtons">
                     <span class="text-sm font-medium text-gray-600 mr-2 flex-shrink-0">Category:</span>
                     <button data-filter="all" class="filter-button-active px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">All</button>
                     <button data-filter="text-ai" class="filter-button-inactive px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">Text</button>
                     <button data-filter="image-ai" class="filter-button-inactive px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">Image</button>
                     <button data-filter="code-ai" class="filter-button-inactive px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">Code</button>
                     <button data-filter="video-ai" class="filter-button-inactive px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">Video</button>
                     <button data-filter="audio-ai" class="filter-button-inactive px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">Audio</button>
                     <button data-filter="utility-ai" class="filter-button-inactive px-3 py-1.5 rounded-md text-xs sm:text-sm font-medium">Utility</button>
                 </div>

                 <!-- Row 2: Search, Sort, Pricing -->
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 items-center">
                     <div class="relative">
                         <input type="text" id="toolSearchInput" placeholder="Search tools..." class="border border-gray-300 rounded-lg px-4 py-2 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                         <i class="fas fa-search absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                     </div>
                     <div class="relative">
                         <select id="toolSortSelect" class="border border-gray-300 rounded-lg px-4 py-2 w-full bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none pr-8">
                             <option value="popularity">Sort: Popularity</option>
                             <option value="rating_desc">Sort: Rating (High-Low)</option>
                             <option value="newest">Sort: Newest</option>
                             <option value="price_asc">Sort: Price (Low-High)</option>
                             <option value="name_asc">Sort: Name (A-Z)</option>
                         </select>
                         <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                     </div>
                     <div class="relative">
                         <select id="pricingFilterSelect" class="border border-gray-300 rounded-lg px-4 py-2 w-full bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none pr-8">
                             <option value="">Pricing: All</option>
                             <option value="free">Pricing: Free</option>
                             <option value="freemium">Pricing: Freemium</option>
                             <option value="paid">Pricing: Paid</option>
                         </select>
                         <i class="fas fa-chevron-down absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                     </div>
                 </div>

                 <!-- Row 3: Tags -->
                 <div class="flex flex-wrap items-center gap-x-4 gap-y-2 border-t pt-3 mt-3" id="tagsFilterContainer">
                     <span class="text-sm font-medium text-gray-600 mr-2 flex-shrink-0">Features/Tags:</span>
                     <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                         <input type="checkbox" value="creative" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded mr-1 focus:ring-indigo-500"> Creative
                     </label>
                     <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                         <input type="checkbox" value="developer" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded mr-1 focus:ring-indigo-500"> Developer
                     </label>
                     <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                         <input type="checkbox" value="writing" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded mr-1 focus:ring-indigo-500"> Writing
                     </label>
                      <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                         <input type="checkbox" value="marketing" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded mr-1 focus:ring-indigo-500"> Marketing
                     </label>
                     <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                         <input type="checkbox" value="vision" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded mr-1 focus:ring-indigo-500"> Vision
                     </label>
                      <label class="inline-flex items-center text-sm text-gray-700 cursor-pointer">
                         <input type="checkbox" value="api" class="form-checkbox h-4 w-4 text-indigo-600 border-gray-300 rounded mr-1 focus:ring-indigo-500"> API
                     </label>
                 </div>

                 <!-- Row 4: Clear Button -->
                 <div class="border-t pt-3 mt-3">
                     <button id="clearFiltersBtn" class="text-xs text-indigo-600 hover:text-indigo-800 hover:underline">
                         <i class="fas fa-times mr-1"></i> Clear All Filters
                     </button>
                 </div>
             </div>
             <!-- END Filter Controls Block -->

             <!-- Tool Grid - This will be populated by JavaScript -->
             <div class="grid grid-cols-1 gap-6 sm:grid-cols-2 lg:grid-cols-3" id="toolsGrid">
                 <!-- JS will insert tool cards here -->
             </div>

             <!-- Load More Tools Button -->
             <div class="mt-8 text-center">
                 <button id="loadMoreTools" class="px-6 py-3 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors">
                     Load More Tools <i class="fas fa-chevron-down ml-2"></i>
                 </button>
                  <p id="no-more-tools" class="text-gray-500 mt-4 hidden">No more tools to load.</p>
             </div>
         </div>
     </section>

     <!-- Comparison Tool Section -->
     <section id="comparison" class="py-12 bg-gray-50">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-8"> Compare AI Tools </h2>
             <p class="text-xl text-gray-500 mb-10 max-w-3xl"> Make an informed decision by comparing features, pricing, and performance of different AI tools side by side. </p>
             <!-- Removed dropdown selection - comparison driven by tray -->
             <div class="bg-white shadow rounded-lg overflow-hidden">
                 <div class="p-6">
                     <!-- Placeholder text updated -->
                     <p id="comparisonPlaceholder" class="text-gray-500 text-center py-10">Add tools to the comparison tray below and click 'Compare Now' to see results here.</p>

                     <!-- Comparison Results Area (Initially Hidden) -->
                     <div id="comparisonResults" class="hidden">
                         <div class="overflow-x-auto mb-10">
                             <table class="min-w-full divide-y divide-gray-200 comparison-table" id="comparisonTable"> <!-- Added class -->
                                 <thead class="bg-gray-50">
                                     <tr>
                                         <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10"> Features </th>
                                         <!-- Tool name headers added by JS -->
                                     </tr>
                                 </thead>
                                 <tbody class="bg-white divide-y divide-gray-200">
                                     <!-- Feature rows added by JS -->
                                 </tbody>
                             </table>
                         </div>
                         <div class="mt-10">
                             <h3 class="text-lg font-medium text-gray-900 mb-4">Performance Benchmark</h3>
                             <div class="w-full h-80 bg-white rounded-lg p-4 border border-gray-200">
                                 <canvas id="performanceChart"></canvas>
                             </div>
                         </div>
                     </div>
                 </div>
             </div>
         </div>
     </section>

     <!-- AI News Section -->
     <section id="news" class="py-12 bg-white">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-6"> AI News & Updates </h2>
             <p class="text-xl text-gray-500 mb-10 max-w-3xl"> Stay informed with the latest AI advancements, tool releases, and industry trends. </p>
             <div class="mb-8">
                 <div class="flex flex-wrap items-center justify-between gap-4">
                     <!-- Filters -->
                     <div class="flex flex-wrap gap-2" id="newsFilterButtons">
                         <button data-filter="all" class="filter-button-active px-4 py-2 rounded-md text-sm font-medium">All News</button>
                         <button data-filter="release" class="filter-button-inactive px-4 py-2 rounded-md text-sm font-medium">Release Updates</button>
                         <button data-filter="trend" class="filter-button-inactive px-4 py-2 rounded-md text-sm font-medium">Industry Trends</button>
                         <button data-filter="research" class="filter-button-inactive px-4 py-2 rounded-md text-sm font-medium">Research Papers</button>
                     </div>
                     <!-- Sort -->
                     <div class="relative">
                         <select id="newsSortSelect" class="border border-gray-300 rounded-lg px-4 py-2 bg-white focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none pr-8">
                             <option value="latest">Sort by: Latest</option>
                             <option value="most_read">Sort by: Most Read</option>
                             <option value="featured">Sort by: Featured</option>
                         </select>
                         <i class="fas fa-chevron-down absolute right-3 top-3 text-gray-400 pointer-events-none"></i>
                     </div>
                 </div>
             </div>

             <!-- News Grid - Populated by JavaScript -->
             <div class="grid grid-cols-1 gap-8 md:grid-cols-2 lg:grid-cols-3" id="newsGrid">
                 <!-- JS will insert news cards here -->
             </div>

             <!-- Load More News Button -->
             <div class="mt-8 text-center">
                 <button id="loadMoreNews" class="px-6 py-3 bg-indigo-600 text-white rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors hidden">
                     Load More News <i class="fas fa-chevron-down ml-2"></i>
                 </button>
                 <p id="no-more-news" class="text-gray-500 mt-4 hidden">No more news articles to load.</p>
             </div>
         </div>
     </section>

     <!-- AI Matchmaker Section -->
     <section id="matchmaker" class="py-12 bg-gray-50">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
             <h2 class="text-3xl font-extrabold text-gray-900 sm:text-4xl mb-8"> AI Matchmaker Quiz </h2>
             <p class="text-xl text-gray-500 mb-10 max-w-3xl"> Answer a few questions to find the perfect AI tool for your needs. </p>
             <div class="bg-white shadow rounded-lg p-6 sm:p-8">
                 <form id="matchmakerForm">
                     <div class="mb-6">
                         <label for="useCaseSelect" class="block text-lg font-medium text-gray-900 mb-2">What’s your primary use case?</label>
                         <div class="relative">
                              <select id="useCaseSelect" name="useCase" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none">
                                 <option value="">Select an option</option>
                                 <option value="Text Generation">Text Generation (Writing, Summarizing)</option>
                                 <option value="Image Creation">Image Creation (Art, Design)</option>
                                 <option value="Coding Assistance">Coding Assistance (Development)</option>
                                 <option value="Video Generation">Video Generation/Editing</option>
                                 <option value="Audio Creation">Audio & Music Creation</option>
                                 <option value="Writing Improvement">Writing Improvement (Grammar, Style)</option>
                             </select>
                             <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-400 pointer-events-none"></i>
                         </div>
                     </div>
                     <div class="mb-6">
                         <label for="budgetSelect" class="block text-lg font-medium text-gray-900 mb-2">What’s your budget?</label>
                          <div class="relative">
                             <select id="budgetSelect" name="budget" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none">
                                 <option value="">Select an option</option>
                                 <option value="Free">Free Tools Only</option>
                                 <option value="Low">Up to $20/month</option>
                                 <option value="Mid">$20 - $50/month</option>
                                 <option value="High">$50+/month or Enterprise</option>
                             </select>
                             <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-400 pointer-events-none"></i>
                         </div>
                     </div>
                     <!-- Corrected Matchmaker Questions -->
                     <div class="mb-6 relative">
                        <label for="taskInput" class="block text-lg font-medium text-gray-900 mb-2">What specific task?</label>
                        <input type="text" id="taskInput" name="task" placeholder="e.g., blog writing, logo design, code debugging..." class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>

                     <div class="mb-6 relative">
                        <label for="industrySelect" class="block text-lg font-medium text-gray-900 mb-2">Your Industry (Optional)</label>
                        <select id="industrySelect" name="industry" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 appearance-none bg-white pr-8">
                            <option value="">Select an industry...</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Software Development">Software Development</option>
                            <option value="Education">Education</option>
                            <option value="E-commerce">E-commerce</option>
                            <option value="Creative">Creative / Design</option>
                            <option value="Research">Research / Academia</option>
                        </select>
                         <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700" style="top: 2.75rem;">
                             <i class="fas fa-chevron-down text-gray-400"></i>
                         </div>
                    </div>
                      <div class="mb-8">
                         <label for="skillLevelSelect" class="block text-lg font-medium text-gray-900 mb-2">What's your technical skill level?</label>
                          <div class="relative">
                             <select id="skillLevelSelect" name="skillLevel" class="border border-gray-300 rounded-lg px-4 py-3 w-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent appearance-none">
                                 <option value="">Select an option</option>
                                 <option value="Beginner">Beginner (Easy to use interface preferred)</option>
                                 <option value="Intermediate">Intermediate (Comfortable with some options)</option>
                                 <option value="Advanced">Advanced (Need power features/API access)</option>
                             </select>
                             <i class="fas fa-chevron-down absolute right-4 top-4 text-gray-400 pointer-events-none"></i>
                         </div>
                     </div>
                     <button type="submit" class="w-full sm:w-auto bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-8 py-3 rounded-md text-base font-medium hover:opacity-90 transition-opacity">
                         <i class="fas fa-magic mr-2"></i> Find My Match
                     </button>
                     <!-- Loading indicator -->
                    <div id="matchmakerLoading" class="text-center mt-4 hidden"><i class="fas fa-spinner fa-spin mr-2"></i> Finding matches...</div>
                 </form>
             </div>
         </div>
     </section>

      <!-- Footer -->
     <footer class="bg-gray-800 text-gray-300 py-8">
         <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
             <p>&copy; 2025 AI Tools Directory. All rights reserved.</p>
             <p class="text-sm mt-2">Your guide to the world of Artificial Intelligence tools.</p>
             <p class="text-sm mt-2">Developed by team Noah.❤️</p>
             <div class="mt-4 space-x-6">
                 <a href="#" class="hover:text-white">About</a>
                 <a href="#" class="hover:text-white">Contact</a>
                 <a href="#" class="hover:text-white">Privacy Policy</a>
             </div>
             <!-- Submit Tool Button -->
             <div class="mt-4">
                <button id="showSubmitToolModalBtn" class="text-indigo-300 hover:text-white hover:underline" style="display: none;"> <!-- Initially hidden -->
                    Submit a Tool
                </button>
             </div>
         </div>
     </footer>

    <!-- Comparison Tray -->
    <div id="comparisonTray" class="fixed bottom-0 left-0 right-0 bg-gray-800 text-white p-3 shadow-lg transform translate-y-full transition-transform duration-300 ease-in-out z-40 hidden">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-2 overflow-x-auto scrollbar-thin scrollbar-thumb-gray-600 scrollbar-track-gray-800" id="comparisonTrayItems">
                <span class="text-sm font-medium mr-2 flex-shrink-0">Comparing:</span>
                <!-- Items added by JS -->
            </div>
            <div class="flex-shrink-0 ml-4 flex items-center">
                <span id="comparisonCount" class="text-sm mr-3">(0/4)</span>
                <button id="compareNowBtnTray" class="bg-indigo-500 hover:bg-indigo-600 text-white px-4 py-1.5 rounded text-sm font-medium disabled:opacity-50 disabled:cursor-not-allowed" disabled>Compare Now</button>
                <button id="clearCompareBtnTray" class="ml-2 text-gray-400 hover:text-white text-sm" title="Clear comparison"><i class="fas fa-times"></i></button>
            </div>
        </div>
    </div>

    <!-- Submit Tool Modal -->
    <div id="submitToolModal" class="modal">
        <div class="modal-content auth-modal"> <!-- Reusing auth-modal size -->
            <span class="close" data-modal-id="submitToolModal">×</span>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 text-center">Submit AI Tool</h2>
            <div id="submitToolModalBody">
                <!-- Form will be added here by JS -->
                <p class="text-center p-4 animate-pulse">Loading form...</p>
            </div>
        </div>
    </div>

     <!-- Main Details/Auth Modal Structure -->
     <div id="detailsModal" class="modal">
         <div class="modal-content"> <!-- JS might add 'auth-modal' class here -->
             <span class="close" id="modalCloseBtn">&times;</span>
             <h2 id="modalTitle" class="text-2xl font-bold mb-4 text-gray-800 text-center"></h2>
             <div id="modalBody" class="text-gray-600 leading-relaxed">
                 <!-- Modal content injected by JS -->
             </div>
         </div>
     </div>

     <!-- JavaScript -->
     <script>
        document.addEventListener('DOMContentLoaded', async () => {

            // --- Configuration ---
            const API_BASE_URL = 'http://localhost:3001/api'; // Ensure this matches your backend
            console.log(`API Base URL set to: ${API_BASE_URL}`);

            // --- Global State Variables ---
            let allToolCards = []; // Holds DOM elements for client-side access if needed
            let allNewsCards = []; // Holds DOM elements for client-side news filtering
            let toolsCurrentPage = 1;
            let newsCurrentPage = 1;
            let totalToolPages = 1;
            let totalNewsPages = 1;
            let currentPerformanceChart = null; // For the comparison chart instance
            let currentToolFilters = {}; // Store current filter state for API calls
            let userFavorites = new Set(); // Stores IDs of favorited tools for logged-in user
            let comparisonList = []; // Array of {id: number, name: string} for comparison tray
            const MAX_COMPARE_ITEMS = 4;
            let searchDebounceTimeout; // For debouncing search input

            // --- DOM Element References ---
            const modal = document.getElementById('detailsModal');
            const modalContentElement = modal?.querySelector('.modal-content');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalCloseBtn = document.getElementById('modalCloseBtn'); // Specific close button for the main modal
            const toolsGrid = document.getElementById('toolsGrid');
            const newsGrid = document.getElementById('newsGrid');
            const loadMoreToolsBtn = document.getElementById('loadMoreTools');
            const loadMoreNewsBtn = document.getElementById('loadMoreNews');
            const noMoreToolsMsg = document.getElementById('no-more-tools');
            const noMoreNewsMsg = document.getElementById('no-more-news');
            const toolFilterControls = document.getElementById('toolFilterControls'); // Container for all tool filters
            const toolFilterButtonsContainer = document.getElementById('toolFilterButtons');
            const toolSearchInput = document.getElementById('toolSearchInput');
            const toolSortSelect = document.getElementById('toolSortSelect');
            const pricingFilterSelect = document.getElementById('pricingFilterSelect');
            const tagsFilterContainer = document.getElementById('tagsFilterContainer');
            const clearFiltersBtn = document.getElementById('clearFiltersBtn');
            const newsFilterButtonsContainer = document.getElementById('newsFilterButtons');
            const newsSortSelect = document.getElementById('newsSortSelect');
            const comparisonResultsDiv = document.getElementById('comparisonResults');
            const comparisonTable = document.getElementById('comparisonTable');
            const comparisonPlaceholder = document.getElementById('comparisonPlaceholder');
            const performanceChartCanvas = document.getElementById('performanceChart');
            const matchmakerForm = document.getElementById('matchmakerForm');
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const mobileMenu = document.getElementById('mobile-menu');
            const heroCategorySelect = document.getElementById('heroCategorySelect');
            const authStatusContainer = document.getElementById('authStatusContainer');
            const authStatusContainerMobile = document.getElementById('authStatusContainerMobile');
            const comparisonTray = document.getElementById('comparisonTray');
            const comparisonTrayItems = document.getElementById('comparisonTrayItems');
            const comparisonCount = document.getElementById('comparisonCount');
            const compareNowBtnTray = document.getElementById('compareNowBtnTray');
            const clearCompareBtnTray = document.getElementById('clearCompareBtnTray');
            const showSubmitToolModalBtn = document.getElementById('showSubmitToolModalBtn');
            const submitToolModal = document.getElementById('submitToolModal');
            const submitToolModalBody = document.getElementById('submitToolModalBody');
            const matchmakerLoading = document.getElementById('matchmakerLoading');

             // --- Auth Form HTML Definitions ---
             const signInContentHTML = `
                <form id="signInForm">
                     <div class="mb-4"> <label for="signInEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label> <input type="email" id="signInEmail" name="email" placeholder="you@example.com" class="input-field" required> </div>
                     <div class="mb-6"> <label for="signInPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label> <input type="password" id="signInPassword" name="password" placeholder="••••••••" class="input-field" required> <a href="#" class="text-xs text-indigo-600 hover:underline mt-1 block text-right modal-form-link">Forgot password?</a> </div>
                     <div id="signInFormMessage" class="text-sm mb-3 text-red-600"></div>
                     <button type="submit" class="w-full btn-primary"> Sign In </button>
                     <p class="text-center text-sm text-gray-500 mt-4"> Don't have an account? <a href="#" class="modal-form-link switch-to-signup">Sign up</a> </p>
                </form>
             `;
             const signUpContentHTML = `
                <form id="signUpForm">
                     <div class="mb-4"> <label for="signUpName" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label> <input type="text" id="signUpName" name="name" placeholder="Your Name" class="input-field" required> </div>
                     <div class="mb-4"> <label for="signUpEmail" class="block text-sm font-medium text-gray-700 mb-1">Email Address</label> <input type="email" id="signUpEmail" name="email" placeholder="you@example.com" class="input-field" required> </div>
                     <div class="mb-4"> <label for="signUpPassword" class="block text-sm font-medium text-gray-700 mb-1">Password</label> <input type="password" id="signUpPassword" name="password" placeholder="Create a password (min 6 chars)" class="input-field" required minlength="6"> </div>
                     <div class="mb-6"> <label for="confirmPassword" class="block text-sm font-medium text-gray-700 mb-1">Confirm Password</label> <input type="password" id="confirmPassword" name="confirmPassword" placeholder="Confirm your password" class="input-field" required> </div>
                     <div id="signUpFormMessage" class="text-sm mb-3 text-red-600"></div>
                     <button type="submit" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white px-4 py-2 rounded-md font-medium hover:opacity-90 transition-opacity"> Create Account </button>
                     <p class="text-center text-sm text-gray-500 mt-4"> Already have an account? <a href="#" class="modal-form-link switch-to-signin">Sign in</a> </p>
                </form>
             `;

            // ==================================================
            // == HELPER FUNCTIONS
            // ==================================================

            /** Safely escapes HTML special characters. */
            function escapeHTML(str) {
                if (str === null || str === undefined) return '';
                return String(str)
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }

            /** Generates FontAwesome star icons based on a rating number. */
            function generateStars(rating) {
                const maxStars = 5; let starsHTML = '';
                const numericRating = parseFloat(rating);
                if (isNaN(numericRating)) return '<span class="text-xs text-gray-400">No rating</span>';
                const fullStars = Math.floor(numericRating); const halfStar = (numericRating % 1) >= 0.4; const emptyStars = maxStars - fullStars - (halfStar ? 1 : 0);
                for (let i = 0; i < fullStars; i++) starsHTML += '<i class="fas fa-star text-yellow-400"></i>';
                if (halfStar) starsHTML += '<i class="fas fa-star-half-alt text-yellow-400"></i>';
                for (let i = 0; i < emptyStars; i++) starsHTML += '<i class="far fa-star text-yellow-300"></i>'; // Use far for empty
                return starsHTML;
            }

            /** Displays a temporary notification message popup. */
            function showTemporaryMessage(message, type = 'info') {
                const msgDiv = document.createElement('div'); let bgColor = 'bg-blue-100 text-blue-800'; if (type === 'success') bgColor = 'bg-green-100 text-green-800'; if (type === 'error') bgColor = 'bg-red-100 text-red-800'; msgDiv.className = `fixed top-20 right-5 p-3 rounded shadow-lg text-sm z-[1100] ${bgColor} transition-opacity duration-500 ease-out opacity-0`; msgDiv.textContent = message; document.body.appendChild(msgDiv); void msgDiv.offsetWidth; setTimeout(() => msgDiv.style.opacity = '1', 50); setTimeout(() => { msgDiv.style.opacity = '0'; setTimeout(() => msgDiv.remove(), 500); }, 2500);
            }

            /** Gathers current filter values from the UI controls. */
             function getCurrentFilters() {
                 const filters = {};
                 const activeCategoryBtn = toolFilterButtonsContainer?.querySelector('.filter-button-active');
                 if (activeCategoryBtn && activeCategoryBtn.dataset.filter !== 'all') {
                     filters.category = activeCategoryBtn.dataset.filter;
                 }
                 if (toolSearchInput?.value.trim()) {
                     filters.search = toolSearchInput.value.trim();
                 }
                 if (toolSortSelect) { // Always include sort, default is 'popularity'
                     filters.sort = toolSortSelect.value;
                 }
                 if (pricingFilterSelect?.value) {
                     filters.pricing = pricingFilterSelect.value;
                 }
                 if (tagsFilterContainer) {
                     const tags = Array.from(tagsFilterContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                     if (tags.length > 0) {
                         filters.tags = tags.join(','); // Comma-separated string for API
                     }
                 }
                 console.log("Current Filters Object:", filters); // Log the collected filters
                 return filters;
                          /** Gathers current filter values from the UI controls. */
          function getCurrentFilters() {
              const filters = {};
              const activeCategoryBtn = toolFilterButtonsContainer?.querySelector('.filter-button-active');
              if (activeCategoryBtn && activeCategoryBtn.dataset.filter !== 'all') {
                  filters.category = activeCategoryBtn.dataset.filter;
              }
              if (toolSearchInput?.value.trim()) {
                  filters.search = toolSearchInput.value.trim();
              }
              if (toolSortSelect) {
                  filters.sort = toolSortSelect.value;
              }
              if (pricingFilterSelect?.value) {
                  filters.pricing = pricingFilterSelect.value;
              }
              if (tagsFilterContainer) {
                  const tags = Array.from(tagsFilterContainer.querySelectorAll('input:checked')).map(cb => cb.value);
                  if (tags.length > 0) {
                      filters.tags = tags.join(','); // Comma-separated string for API
                  }
              }
              // console.log("Current Filters Object:", filters); // Keep this commented unless debugging
              return filters;
          }
             }

            // ==================================================
            // == LOCALSTORAGE Persistence Functions
            // ==================================================
            function saveFiltersToLocalStorage(filters) { try { localStorage.setItem('aiToolsFilters', JSON.stringify(filters)); } catch (e) { console.error('LS Filter Save Error:', e); } }
            function loadFiltersFromLocalStorage() { try { const s = localStorage.getItem('aiToolsFilters'); return s ? JSON.parse(s) : {}; } catch (e) { console.warn('LS Filter Load Error:', e); localStorage.removeItem('aiToolsFilters'); return {}; } }
            function applySavedFiltersToUI(filters) { if (!filters) return; console.log("Applying saved filters to UI:", filters); if (toolFilterButtonsContainer) { toolFilterButtonsContainer.querySelectorAll('button').forEach(btn => { const isActive = (filters.category && btn.dataset.filter === filters.category) || (!filters.category && btn.dataset.filter === 'all'); btn.classList.toggle('filter-button-active', isActive); btn.classList.toggle('filter-button-inactive', !isActive); }); } if (toolSearchInput && filters.search) toolSearchInput.value = filters.search; if (toolSortSelect && filters.sort) toolSortSelect.value = filters.sort; if (pricingFilterSelect && filters.pricing) pricingFilterSelect.value = filters.pricing; if (tagsFilterContainer && filters.tags) { const tagsArray = filters.tags.split(','); tagsFilterContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = tagsArray.includes(cb.value); }); } }
            function clearFiltersFromLocalStorage() { try { localStorage.removeItem('aiToolsFilters'); console.log("Cleared filters from LS."); } catch(e) { console.error("LS Clear Error:", e);}}
            function saveComparisonToLocalStorage() { try { localStorage.setItem('aiComparisonList', JSON.stringify(comparisonList)); } catch(e) { console.error("LS Compare Save Error:", e); } }
            function loadComparisonFromLocalStorage() { const saved = localStorage.getItem('aiComparisonList'); if (saved) { try { const parsed = JSON.parse(saved); if (Array.isArray(parsed) && parsed.every(item => typeof item === 'object' && item !== null && 'id' in item && 'name' in item)) { comparisonList = parsed; console.log("Loaded comparison from LS:", comparisonList); } else { throw new Error("Invalid comparison data format"); } } catch (e) { console.warn("LS Compare Load Error:", e); localStorage.removeItem('aiComparisonList'); comparisonList = []; } } }

            // ==================================================
            // == UI RENDERING FUNCTIONS
            // ==================================================
            /** Creates a tool card DOM element from tool data object. */
             function createToolCardFromData(tool) {
                 if (!tool?.id || !tool.slug || !tool.name) { console.warn("Skipping tool card render - missing essential data:", tool); return null; }
                 const isFavorited = userFavorites.has(tool.id); const isInCompare = comparisonList.some(item => item.id === tool.id); const starsHTML = generateStars(tool.rating_avg); const ratingDisplay = !isNaN(parseFloat(tool.rating_avg)) ? parseFloat(tool.rating_avg).toFixed(1) : 'N/A';
                 const card = document.createElement('div'); card.className = 'bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden tool-card transition-shadow duration-200 hover:shadow-md'; card.dataset.slug = tool.slug; card.dataset.id = tool.id; card.dataset.category = tool.category_slug || 'unknown'; // Ensure category is added for potential client filtering fallbacks
                 let iconClass = 'fa-puzzle-piece text-gray-600'; let bgColorClass = 'bg-gray-100';
                 switch(tool.category_slug){ case 'text-ai': iconClass='fa-robot text-blue-600'; bgColorClass='bg-blue-100'; break; case 'image-ai': iconClass='fa-palette text-purple-600'; bgColorClass='bg-purple-100'; break; case 'code-ai': iconClass='fa-code text-green-600'; bgColorClass='bg-green-100'; break; case 'video-ai': iconClass='fa-video text-red-600'; bgColorClass='bg-red-100'; break; case 'audio-ai': iconClass='fa-music text-yellow-600'; bgColorClass='bg-yellow-100'; break; case 'utility-ai': iconClass='fa-cogs text-emerald-600'; bgColorClass='bg-emerald-100'; break; }
                 const safeName = escapeHTML(tool.name); const safeDesc = escapeHTML(tool.description || 'No description available.'); const safePricingText = escapeHTML(tool.pricing_text || 'N/A'); const safeTags = (tool.tags_array || []).map(tag => `<span class="bg-gray-100 text-gray-800 text-xs font-medium px-2 py-0.5 rounded">${escapeHTML(tag)}</span>`);
                 const tryNowUrl = tool.try_now_url || tool.website_url || '#'; const tryNowText = (tool.try_now_url && tool.try_now_url !== '#') ? 'Try Now' : 'Visit Site';
                 const isLoggedIn = !!localStorage.getItem('authToken');

                 card.innerHTML = `
                    <div class="p-4 sm:p-5 relative">
                        <button class="absolute top-3 right-3 z-10 text-gray-400 hover:text-red-500 favorite-btn p-1 rounded-full hover:bg-red-100 ${isFavorited ? 'favorited' : ''}" data-tool-id="${tool.id}" title="${isFavorited ? 'Remove favorite' : 'Add favorite'}" aria-label="Toggle Favorite" style="${isLoggedIn ? '' : 'display: none;'}">
                            <i class="fa-heart ${isFavorited ? 'fas' : 'far'}"></i>
                        </button>
                        <div class="flex items-center mb-3">
                            <div class="shrink-0 h-10 w-10 ${bgColorClass} rounded-lg flex items-center justify-center mr-3"><i class="fas ${iconClass} fa-fw"></i></div>
                            <div class="min-w-0">
                                <h3 class="text-base sm:text-lg font-semibold text-gray-900 truncate" title="${safeName}">${safeName}</h3>
                                <p class="text-xs sm:text-sm text-gray-500 truncate" title="${escapeHTML(tool.vendor_name || '')}">${escapeHTML(tool.vendor_name || '')}</p>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mb-3 text-xs sm:text-sm">
                            <div class="flex items-center text-gray-600" title="Rating: ${ratingDisplay}/5 (${tool.review_count||0} reviews)">
                                ${starsHTML}
                                <span class="ml-1 text-gray-500">(${tool.review_count||0})</span>
                            </div>
                            <div class="text-gray-700 font-medium tool-price text-right truncate" title="${safePricingText}">${safePricingText}</div>
                        </div>
                        <p class="text-gray-600 text-xs sm:text-sm mb-3 line-clamp-2 sm:line-clamp-3" title="${safeDesc}">${safeDesc}</p>
                        <div class="flex flex-wrap gap-1 mb-4 min-h-[24px]">
                            ${safeTags.slice(0, 3).join('')}
                            ${(tool.tags_array && tool.tags_array.length > 3) ? `<span class="text-xs text-gray-400">+${tool.tags_array.length - 3}</span>` : ''}
                        </div>
                        <div class="flex justify-between items-center gap-2">
                            <a href="#" class="text-indigo-600 hover:text-indigo-500 font-medium text-xs sm:text-sm view-details" data-tool-slug="${tool.slug}" data-tool-name="${safeName}">Details</a>
                            <button class="add-compare-btn text-xs px-2 py-1 border border-indigo-300 text-indigo-600 rounded hover:bg-indigo-50 disabled:opacity-50 disabled:cursor-not-allowed disabled:border-gray-300 disabled:text-gray-400 disabled:hover:bg-transparent" data-tool-id="${tool.id}" data-tool-name="${safeName}" ${isInCompare ? 'disabled' : ''}>
                                ${isInCompare ? '<i class="fas fa-check text-green-500"></i> Added' : 'Compare'}
                            </button>
                            <a href="${escapeHTML(tryNowUrl)}" target="_blank" rel="noopener noreferrer" class="px-3 py-1 bg-indigo-600 text-white text-xs sm:text-sm rounded-md hover:bg-indigo-700 try-now whitespace-nowrap">
                                 ${tryNowText}
                             </a>
                        </div>
                    </div>`;
                 return card;
             }

            /** Creates a news card DOM element. */
            function createNewsCardFromData(article) {
                if (!article?.slug || !article.title) { console.warn("Skipping news card render - missing essential data:", article); return null; }
                const card = document.createElement('div'); card.className='bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden news-card transition-shadow duration-200 hover:shadow-md'; card.dataset.category=article.category||'general'; card.dataset.date=article.published_date?new Date(article.published_date).toISOString().split('T')[0]:''; card.dataset.slug=article.slug;
                let tagBg='bg-gray-100', tagText='text-gray-800', catText='General'; switch(article.category){ case 'release': tagBg='bg-blue-100'; tagText='text-blue-800'; catText='Release'; break; case 'trend': tagBg='bg-purple-100'; tagText='text-purple-800'; catText='Trend'; break; case 'research': tagBg='bg-green-100'; tagText='text-green-800'; catText='Research'; break; case 'update': tagBg='bg-yellow-100'; tagText='text-yellow-800'; catText='Update'; break; }
                const imgUrl=escapeHTML(article.image_url||`https://via.placeholder.com/400x192/E2E8F0/4A5568?text=News`); const date=article.published_date?new Date(article.published_date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'N/A';
                const safeTitle = escapeHTML(article.title); const safeAuthor = escapeHTML(article.author || ''); const safeDesc = escapeHTML(article.content ? (article.content.length > 120 ? article.content.substring(0,117) + '...' : article.content) : 'No preview available.');

                card.innerHTML = `
                   <a href="#" class="block read-more group" data-news-slug="${article.slug}" data-news-title="${safeTitle}">
                       <div class="h-40 bg-gray-200 relative overflow-hidden">
                           <img loading="lazy" src="${imgUrl}" alt="${safeTitle}" class="absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-105">
                           <div class="absolute top-2 left-2"><span class="${tagBg} ${tagText} text-xs font-medium px-2 py-0.5 rounded">${catText}</span></div>
                       </div>
                       <div class="p-4">
                           <p class="text-xs text-gray-500 mb-1">${date}${safeAuthor ? ` by ${safeAuthor}` : ''}</p>
                           <h3 class="text-base font-semibold text-gray-900 mb-2 group-hover:text-indigo-600 line-clamp-2">${safeTitle}</h3>
                           <p class="text-xs text-gray-600 line-clamp-2">${safeDesc}</p>
                       </div>
                   </a>`;
                return card;
            }

            /** Updates visibility and text of a 'Load More' button. */
            function updateLoadMoreButton(type, currentPage, totalPages) {
                const btn = type === 'tools' ? loadMoreToolsBtn : loadMoreNewsBtn;
                const msg = type === 'tools' ? noMoreToolsMsg : noMoreNewsMsg;
                if (!btn || !msg) return;
                totalPages = Math.max(1, totalPages);
                const grid = type === 'tools' ? toolsGrid : newsGrid;
                const hasContent = grid?.children.length > 0 && !grid?.querySelector('#no-results-message-tools') && !grid?.querySelector('#no-results-news'); // Check if grid has non-message content

                if (currentPage >= totalPages) {
                    btn.classList.add('hidden');
                    // Only show "no more" message if there was actually content loaded/displayed
                    msg.classList.toggle('hidden', !hasContent);
                } else {
                    btn.classList.remove('hidden');
                    msg.classList.add('hidden');
                }
                btn.disabled = false;
                btn.innerHTML = `Load More ${type === 'tools' ? 'Tools' : 'News'} <i class="fas fa-chevron-down ml-2"></i>`;
            }

            /** Shows or hides a loading indicator in the specified grid. */
            function showLoadingState(type, isLoading, message = `Loading ${type}...`) {
                const grid = type === 'tools' ? toolsGrid : newsGrid;
                const id = `loading-${type}-indicator`;
                let indicator = document.getElementById(id);

                if (isLoading) {
                    if (!indicator && grid) {
                        grid.innerHTML = ''; // Clear previous results before showing loading
                        indicator = document.createElement('div');
                        indicator.id = id;
                        indicator.className = 'col-span-full text-center py-10 text-gray-500';
                        indicator.innerHTML = `<i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p>${message}</p>`;
                        grid.appendChild(indicator);
                    }
                } else {
                    if (indicator) indicator.remove();
                }
            }

            // ==================================================
            // == FETCHING FUNCTIONS
            // ==================================================
            /** Fetches initial tools and news, renders them. Uses current filters state. */
            async function fetchAndRenderInitialData() {
                console.log('Fetching initial data...');
                showLoadingState('tools', true); showLoadingState('news', true);
                try {
                    currentToolFilters = getCurrentFilters(); // Get current filters from UI/storage
                    const toolParams = new URLSearchParams({ limit: 9, page: 1, ...currentToolFilters });
                    const newsParams = new URLSearchParams({ limit: 3, page: 1 }); // Keep news fetch simple initially

                    console.log("Fetching tools with params:", toolParams.toString());
                    console.log("Fetching news with params:", newsParams.toString());

                    const [toolResponse, newsResponse] = await Promise.all([
                        fetch(`${API_BASE_URL}/tools?${toolParams.toString()}`).catch(e => { console.error('Tool fetch network error:', e); return { ok: false, statusText: e.message, status: 0, json: async () => ({ error: `Network error: ${e.message}`}) }; }),
                        fetch(`${API_BASE_URL}/news?${newsParams.toString()}`).catch(e => { console.error('News fetch network error:', e); return { ok: false, statusText: e.message, status: 0, json: async () => ({ error: `Network error: ${e.message}`}) }; })
                    ]);

                    showLoadingState('tools', false); showLoadingState('news', false); // Hide loading states regardless of success/failure

                    // Process Tools Response
                    let toolData = { tools: [], pagination: {} };
                    if (!toolResponse.ok) {
                        const errorJson = await toolResponse.json().catch(() => ({error: toolResponse.statusText}));
                        console.error(`Tool Fetch Error: ${toolResponse.statusText} (${toolResponse.status})`, errorJson);
                        if (toolsGrid) toolsGrid.innerHTML = `<p id="no-results-message-tools" class="col-span-full py-10 text-center text-red-500">Failed to load tools: ${escapeHTML(errorJson.error || toolResponse.statusText)}. Check connection and backend logs.</p>`;
                        allToolCards = [];
                    } else {
                         toolData = await toolResponse.json();
                         console.log("Tool data received:", toolData);
                         if (toolsGrid) {
                             toolsGrid.innerHTML = ''; // Clear previous results/error messages
                             if (toolData.tools?.length > 0) {
                                 const toolFragment = document.createDocumentFragment();
                                 toolData.tools.forEach(tool => { const card = createToolCardFromData(tool); if(card) toolFragment.appendChild(card); });
                                 toolsGrid.appendChild(toolFragment);
                                 allToolCards = Array.from(toolsGrid.querySelectorAll('.tool-card')); // Update master list
                                 attachAllToolCardEvents(toolsGrid); // Attach event listeners
                             } else {
                                 toolsGrid.innerHTML = '<p id="no-results-message-tools" class="col-span-full py-10 text-center text-gray-500">No tools found matching your criteria.</p>';
                                 allToolCards = [];
                             }
                         }
                    }
                    // Update tool pagination and load more button state
                    toolsCurrentPage = toolData.pagination?.currentPage || 1;
                    totalToolPages = toolData.pagination?.totalPages || 1;
                    updateLoadMoreButton('tools', toolsCurrentPage, totalToolPages);


                    // Process News Response
                    let newsData = { news: [], pagination: {} };
                    if (!newsResponse.ok) {
                         const errorJson = await newsResponse.json().catch(() => ({error: newsResponse.statusText}));
                         console.error(`News Fetch Error: ${newsResponse.statusText} (${newsResponse.status})`, errorJson);
                        if (newsGrid) newsGrid.innerHTML = `<p id="no-results-news" class="col-span-full py-10 text-center text-red-500">Failed to load news: ${escapeHTML(errorJson.error || newsResponse.statusText)}.</p>`;
                        allNewsCards = [];
                    } else {
                         newsData = await newsResponse.json();
                         console.log("News data received:", newsData);
                         if (newsGrid) {
                            newsGrid.innerHTML = '';
                            if (newsData.news?.length > 0) {
                                const newsFragment = document.createDocumentFragment();
                                newsData.news.forEach(article => { const card = createNewsCardFromData(article); if(card) newsFragment.appendChild(card); });
                                newsGrid.appendChild(newsFragment);
                                allNewsCards = Array.from(newsGrid.querySelectorAll('.news-card')); // Update master list
                            } else {
                                newsGrid.innerHTML = '<p id="no-results-news" class="col-span-full py-10 text-center text-gray-500">No news articles found.</p>';
                                allNewsCards = [];
                            }
                        }
                    }
                    // Update news pagination and load more button state
                    newsCurrentPage = newsData.pagination?.currentPage || 1;
                    totalNewsPages = newsData.pagination?.totalPages || 1;
                    updateLoadMoreButton('news', newsCurrentPage, totalNewsPages);
                    filterAndSortNews(); // Apply client-side filtering for news

                    // Update other UI elements based on fetched data/state
                    updateComparisonTray();
                    updateFavoriteButtonsUI();

                } catch (error) { // Catch any unexpected errors during processing
                    console.error("Failed to fetch/render initial data:", error);
                    showLoadingState('tools', false); showLoadingState('news', false);
                    if (toolsGrid && !toolsGrid.innerHTML) toolsGrid.innerHTML = `<p class="col-span-full py-10 text-center text-red-500">An error occurred loading tools: ${escapeHTML(error.message)}</p>`;
                    if (newsGrid && !newsGrid.innerHTML) newsGrid.innerHTML = `<p class="col-span-full py-10 text-center text-red-500">An error occurred loading news: ${escapeHTML(error.message)}</p>`;
                    updateLoadMoreButton('tools', 1, 1);
                    updateLoadMoreButton('news', 1, 1);
                }
            }

             /** Fetches and displays detailed tool information in the main modal. */
             async function handleViewDetails(e) {
                 e.preventDefault();
                 const link = e.target.closest('.view-details, .view-details-matchmaker, .view-details-alternative');
                 if (!link) return;
                 const toolSlug = link.dataset.toolSlug;
                 const toolName = escapeHTML(link.dataset.toolName || 'Tool Details');
                 if (!toolSlug) { console.error("Missing tool slug for details view"); return; }

                 console.log(`Fetching details for: ${toolSlug}`);
                 showModal('detailsModal', `${toolName} - Details`, '<div class="text-center p-6"><i class="fas fa-spinner fa-spin fa-2x text-indigo-600"></i><p class="mt-2 text-gray-500">Loading details...</p></div>');

                 try {
                     const detailsRes = await fetch(`${API_BASE_URL}/tools/${toolSlug}`);
                     if (!detailsRes.ok) { const err = await detailsRes.json().catch(()=>{}); throw new Error(err?.error || `Details fetch failed: ${detailsRes.statusText} (${detailsRes.status})`); }
                     const tool = await detailsRes.json();
                     const toolId = tool.id; // Get ID for reviews/favorites

                     let reviews = [];
                     if (toolId) {
                          try {
                              const reviewsRes = await fetch(`${API_BASE_URL}/tools/${toolId}/reviews`); // Fetch reviews by ID
                              if (reviewsRes.ok) reviews = await reviewsRes.json();
                              else console.warn(`Reviews fetch failed: ${reviewsRes.statusText} (${reviewsRes.status})`);
                          } catch (reviewError) { console.warn("Could not fetch reviews:", reviewError); }
                     } else { console.warn("Tool ID not found in details response, cannot fetch reviews."); }

                     // --- Build Modal Content ---
                     const numericRatingModal = parseFloat(tool.rating_avg);
                     const ratingDisplayModal = !isNaN(numericRatingModal) ? numericRatingModal.toFixed(1) : 'N/A';
                     const starsHTML = generateStars(numericRatingModal);
                     const reviewCount = tool.review_count || 0;
                     const features = tool.features_json || {};
                     const screenshots = tool.screenshots_array || [];
                     const pricingTiers = tool.pricing_tiers_json || [];
                     const docsUrl = tool.documentation_url;
                     const alternatives = tool.alternatives_array || []; // Expecting array of slugs
                     const lastUpdated = tool.updated_at;
                     const tryNowUrl = tool.try_now_url || tool.website_url || '#';
                     const tryNowText = (tool.try_now_url && tool.try_now_url !== '#') ? 'Try Now' : 'Visit Site';
                     const isLoggedIn = !!localStorage.getItem('authToken');

                     // Safely build HTML sections
                     let featuresHTML = ''; if (Object.keys(features).length > 0) { featuresHTML = '<h4 class="font-semibold text-gray-800 mt-4 mb-2">Key Features:</h4><ul class="list-disc list-inside text-sm space-y-1 text-gray-600">'; for (const featureName in features) { let featureValue = features[featureName]; let displayValue = ''; if (typeof featureValue === 'boolean') { displayValue = featureValue ? '<i class="fas fa-check text-green-500 ml-1"></i>' : '<i class="fas fa-times text-red-500 ml-1"></i>'; } else { displayValue = `: ${escapeHTML(String(featureValue))}`; } featuresHTML += `<li><strong>${escapeHTML(featureName)}</strong>${displayValue}</li>`; } featuresHTML += '</ul>'; }
                     let screenshotsHTML = ''; if (screenshots.length > 0) { screenshotsHTML = '<h4 class="font-semibold text-gray-800 mt-4 mb-2">Screenshots:</h4><div class="flex space-x-2 overflow-x-auto pb-2">'; screenshots.forEach(url => { screenshotsHTML += `<a href="${escapeHTML(url)}" target="_blank" rel="noopener noreferrer"><img loading="lazy" src="${escapeHTML(url)}" alt="${escapeHTML(tool.name)} Screenshot" class="h-32 rounded border border-gray-200 hover:opacity-90 object-contain"></a>`; }); screenshotsHTML += '</div>'; }
                     let pricingHTML = '<h4 class="font-semibold text-gray-800 mt-4 mb-2">Pricing:</h4>'; if (pricingTiers.length > 0) { pricingHTML += '<div class="space-y-3">'; pricingTiers.forEach(tier => { pricingHTML += `<div class="border rounded p-3 bg-gray-50 text-sm"><p class="font-medium text-gray-800">${escapeHTML(tier.name||'Tier')} - <span class="font-bold">${escapeHTML(tier.price||'N/A')}</span></p>`; if (tier.features?.length > 0) { pricingHTML += `<ul class="list-disc list-inside text-xs text-gray-600 mt-1 pl-4 space-y-0.5">${tier.features.map(f => `<li>${escapeHTML(f)}</li>`).join('')}</ul>`; } pricingHTML += `</div>`; }); pricingHTML += '</div>'; } else if (tool.pricing_text) { pricingHTML += `<p class="text-sm text-gray-600">${escapeHTML(tool.pricing_text)}</p>`; } else { pricingHTML += '<p class="text-sm text-gray-600">N/A</p>'; }
                     const docsLinkHTML = docsUrl ? `<a href="${escapeHTML(docsUrl)}" target="_blank" rel="noopener noreferrer" class="inline-block px-3 py-1 bg-gray-200 text-gray-700 text-xs rounded hover:bg-gray-300 mr-2 docs-link-modal">Docs <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>` : '';
                     let alternativesHTML = ''; if (alternatives.length > 0) { alternativesHTML = '<h4 class="font-semibold text-gray-800 mt-4 mb-2">Alternatives:</h4><div class="flex flex-wrap gap-2">'; alternatives.forEach(altSlug => { // Find name from currently loaded cards if possible, otherwise use slug
                          const altCard = allToolCards.find(c => c.dataset.slug === altSlug);
                          const altName = escapeHTML(altCard?.querySelector('h3')?.textContent || altSlug); // Fallback to slug
                          alternativesHTML += `<a href="#" class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded hover:bg-blue-200 view-details-alternative" data-tool-slug="${escapeHTML(altSlug)}" data-tool-name="${altName}">${altName}</a>`; }); alternativesHTML += '</div>'; }
                     const lastUpdatedHTML = lastUpdated ? `<p class="text-xs text-gray-400 mt-6 text-right">Info updated: ${new Date(lastUpdated).toLocaleDateString()}</p>` : '';
                     let reviewsHTML = '<h4 class="font-semibold text-gray-800 mt-6 mb-3">User Reviews</h4>'; if (reviews?.length > 0) { reviewsHTML += '<div class="space-y-4 max-h-60 overflow-y-auto pr-2 border-t pt-4">'; reviews.forEach(review => { reviewsHTML += `<div class="border-b pb-3"><div class="flex items-center justify-between mb-1"><span class="font-medium text-sm text-gray-700">${escapeHTML(review.user_name || 'User')}</span><span class="text-xs text-gray-500">${new Date(review.created_at).toLocaleDateString()}</span></div><div class="mb-1">${generateStars(review.rating)}</div><p class="text-sm text-gray-600">${escapeHTML(review.review_text || '')}</p></div>`; }); reviewsHTML += '</div>'; } else { reviewsHTML += '<p class="text-sm text-gray-500 border-t pt-4">No reviews yet.</p>'; }
                     const reviewFormHTML = `
                        <div id="review-form-container" class="mt-6 pt-6 border-t ${isLoggedIn ? '' : 'hidden'} requires-auth">
                            <h4 class="font-semibold text-gray-800 mb-3">Leave a Review</h4>
                            <form id="modalReviewForm" data-tool-id="${toolId || ''}">
                                <div class="mb-3">
                                    <label class="block text-sm font-medium mb-1">Rating:</label>
                                    <div class="flex items-center star-rating-input" data-rating-value="0">
                                        ${[5, 4, 3, 2, 1].map(s => `<input type="radio" id="star${s}" name="rating" value="${s}" class="sr-only" required><label for="star${s}" title="${s} stars" class="text-gray-300 hover:text-yellow-400 cursor-pointer text-2xl transition-colors"><i class="far fa-star"></i></label>`).join('')}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="reviewText" class="block text-sm font-medium mb-1">Review (Optional):</label>
                                    <textarea id="reviewText" name="reviewText" rows="3" placeholder="Share your experience..." class="input-field"></textarea>
                                </div>
                                <div id="reviewFormMessage" class="text-sm mb-3"></div>
                                <button type="submit" class="btn-primary px-4 py-2 text-sm bg-green-600 hover:bg-green-700">Submit Review</button>
                            </form>
                        </div>
                        ${!isLoggedIn ? '<p class="text-sm text-gray-500 mt-6 pt-6 border-t">Please <a href="#" class="text-indigo-600 hover:underline switch-to-signin modal-form-link">sign in</a> to leave a review.</p>' : ''}
                     `;

                     const finalModalContent = `
                        <p class="mb-2 text-sm text-gray-500">Category: ${escapeHTML(tool.category_name || 'N/A')}</p>
                        <div class="flex items-center mb-3" title="Rating: ${ratingDisplayModal}/5 (${reviewCount} reviews)">
                            <strong class="mr-2 text-sm">Rating:</strong> ${starsHTML} <span class="text-xs text-gray-500 ml-2">(${reviewCount} reviews)</span>
                        </div>
                        <p class="mb-4 text-gray-700">${escapeHTML(tool.description || 'No description.')}</p>
                        <div class="flex flex-wrap gap-2 mb-4 border-t pt-4">
                            <a href="${escapeHTML(tool.website_url || '#')}" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-indigo-600 text-white text-sm rounded-md hover:bg-indigo-700">
                                Visit Site <i class="fas fa-external-link-alt ml-1 text-xs"></i>
                            </a>
                            ${tryNowUrl !== '#' && tryNowUrl !== tool.website_url ? `<a href="${escapeHTML(tryNowUrl)}" target="_blank" rel="noopener noreferrer" class="inline-block px-4 py-2 bg-green-600 text-white text-sm rounded-md hover:bg-green-700 try-now-modal">${tryNowText} <i class="fas fa-external-link-alt ml-1 text-xs"></i></a>` : ''}
                            ${docsLinkHTML}
                            <button
                                class="favorite-btn text-gray-400 hover:text-red-500 px-3 py-2 text-lg ${userFavorites.has(toolId) ? 'favorited' : ''}"
                                data-tool-id="${toolId || ''}" title="${userFavorites.has(toolId) ? 'Remove favorite' : 'Add favorite'}"
                                style="${isLoggedIn ? '' : 'display: none;'}" aria-label="Toggle Favorite">
                                <i class="${userFavorites.has(toolId) ? 'fas' : 'far'} fa-heart"></i>
                            </button>
                        </div>
                        ${pricingHTML}
                        ${featuresHTML}
                        ${screenshotsHTML}
                        ${alternativesHTML}
                        <hr class="my-6">
                        ${reviewsHTML}
                        ${reviewFormHTML}
                        ${lastUpdatedHTML}
                     `;

                     if(modalTitle) modalTitle.textContent = `${escapeHTML(tool.name)} - Details`;
                     if(modalBody) modalBody.innerHTML = finalModalContent;
                     setupStarRatingInput(); // Initialize star rating input within the modal

                 } catch (error) {
                     console.error("Error fetching/displaying tool details:", error);
                     showModal('detailsModal', 'Error', `<p class="text-red-500 text-center p-4">Could not load details. ${escapeHTML(error.message)}</p>`);
                 }
             }

            /** Fetches and appends the next page of tools based on current filters. */
            async function handleLoadMoreTools() {
                if (toolsCurrentPage >= totalToolPages) return;
                toolsCurrentPage++;
                console.log(`Loading tools page ${toolsCurrentPage} with filters:`, currentToolFilters);
                if(loadMoreToolsBtn) { loadMoreToolsBtn.disabled = true; loadMoreToolsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...'; }
                try {
                    const params = new URLSearchParams({ limit: 6, page: toolsCurrentPage, ...currentToolFilters }); // Fetch fewer on load more
                    const res = await fetch(`${API_BASE_URL}/tools?${params.toString()}`);
                    if (!res.ok) { const err = await res.json().catch(()=>{}); throw new Error(err?.error || `HTTP error: ${res.statusText} (${res.status})`); }
                    const data = await res.json();

                    if (data.tools?.length > 0) {
                        const fragment = document.createDocumentFragment();
                        data.tools.forEach(tool => {
                            const card = createToolCardFromData(tool);
                             if (card) {
                                 fragment.appendChild(card);
                                 attachSingleToolCardEvents(card); // Attach events ONLY to newly added cards
                             }
                        });
                        toolsGrid?.appendChild(fragment);
                        allToolCards = allToolCards.concat(Array.from(fragment.querySelectorAll('.tool-card'))); // Update master list efficiently
                        updateComparisonTray(); // Update compare buttons status on new cards
                        updateFavoriteButtonsUI(); // Update favorite buttons status on new cards
                    } else {
                        // If API returns empty, assume no more pages
                        totalToolPages = toolsCurrentPage;
                    }
                    // Update total pages based on response, potentially overriding the above assumption
                    totalToolPages = data.pagination?.totalPages || totalToolPages;
                    updateLoadMoreButton('tools', toolsCurrentPage, totalToolPages);

                } catch (error) {
                    console.error("Load more tools error:", error);
                    if(loadMoreToolsBtn){ loadMoreToolsBtn.innerHTML = 'Load More Tools <i class="fas fa-exclamation-circle ml-2"></i>'; loadMoreToolsBtn.disabled = false; }
                    toolsCurrentPage--; // Revert page number on error
                    showTemporaryMessage(`Error loading more tools: ${escapeHTML(error.message)}`, 'error');
                }
            }

            /** Fetches and appends the next page of news. */
             async function handleLoadMoreNews() {
                 if (newsCurrentPage >= totalNewsPages) return;
                 newsCurrentPage++;
                 console.log(`Loading news page ${newsCurrentPage}...`);
                 if(loadMoreNewsBtn) { loadMoreNewsBtn.disabled = true; loadMoreNewsBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...'; }
                 try {
                     const res = await fetch(`${API_BASE_URL}/news?page=${newsCurrentPage}&limit=3`);
                     if (!res.ok) { const err = await res.json().catch(()=>{}); throw new Error(err?.error || `HTTP error: ${res.statusText} (${res.status})`); }
                     const data = await res.json();

                     if (data.news?.length > 0) {
                         const fragment = document.createDocumentFragment();
                         data.news.forEach(a => { const c = createNewsCardFromData(a); if (c) fragment.appendChild(c); });
                         newsGrid?.appendChild(fragment);
                         allNewsCards = allNewsCards.concat(Array.from(fragment.querySelectorAll('.news-card'))); // Update master list
                     } else {
                         totalNewsPages = newsCurrentPage; // Assume no more pages
                     }
                     totalNewsPages = data.pagination?.totalPages || totalNewsPages;
                     updateLoadMoreButton('news', newsCurrentPage, totalNewsPages);
                     filterAndSortNews(); // Re-apply client-side filter/sort

                 } catch (error) {
                     console.error("Load more news error:", error);
                     if(loadMoreNewsBtn){ loadMoreNewsBtn.innerHTML = 'Load More News <i class="fas fa-exclamation-circle ml-2"></i>'; loadMoreNewsBtn.disabled = false; }
                     newsCurrentPage--; // Revert page number on error
                     showTemporaryMessage(`Error loading more news: ${escapeHTML(error.message)}`, 'error');
                 }
             }

            /** Fetches tools from page 1 using current filters and replaces grid content. */
                      /** Fetches tools from page 1 using current filters and replaces grid content. */
          async function applyFiltersAndSearch() {
              console.log("Applying filters and searching...");
              const filterWrapper = document.getElementById('toolFilterControls');
              if (filterWrapper) filterWrapper.style.opacity = '0.7';
              showLoadingState('tools', true, 'Applying filters...');

              currentToolFilters = getCurrentFilters();
              toolsCurrentPage = 1;
              saveFiltersToLocalStorage(currentToolFilters);

              try {
                  const params = new URLSearchParams({ limit: 9, page: toolsCurrentPage, ...currentToolFilters });
                  const requestUrl = `${API_BASE_URL}/tools?${params.toString()}`; // Construct URL first
                  console.log("Fetching filtered tools with URL:", requestUrl); // Log the exact URL

                  const res = await fetch(requestUrl); // Use the constructed URL
                  if (!res.ok) { const err = await res.json().catch(()=>{ return {error: `Server Error (${res.status})`} }); throw new Error(err.error || `Filter Error: ${res.statusText} (${res.status})`); }
                  const data = await res.json();
                  console.log("Filtered tool data received:", data);
                  showLoadingState('tools', false);

                  if (toolsGrid) toolsGrid.innerHTML = '';
                  if (data.tools?.length > 0) {
                      const frag = document.createDocumentFragment();
                      data.tools.forEach(t => { const c = createToolCardFromData(t); if (c) frag.appendChild(c); });
                      toolsGrid?.appendChild(frag);
                      allToolCards = Array.from(toolsGrid.querySelectorAll('.tool-card'));
                      attachAllToolCardEvents(toolsGrid);
                  } else {
                      if (toolsGrid) toolsGrid.innerHTML = '<p id="no-results-message-tools" class="col-span-full py-10 text-center text-gray-500">No tools match your current filters.</p>';
                      allToolCards = [];
                  }
                  toolsCurrentPage = data.pagination?.currentPage || 1;
                  totalToolPages = data.pagination?.totalPages || 1;
                  updateLoadMoreButton('tools', toolsCurrentPage, totalToolPages);
                  updateComparisonTray();
                  updateFavoriteButtonsUI();

              } catch (error) {
                  console.error("Filter apply error:", error);
                  showLoadingState('tools', false);
                  if (toolsGrid) toolsGrid.innerHTML = `<p class="col-span-full py-10 text-center text-red-500">Failed to load filtered tools. ${escapeHTML(error.message)}</p>`;
                  updateLoadMoreButton('tools', 1, 1);
                  showTemporaryMessage(`Error applying filters: ${escapeHTML(error.message)}`, 'error');
              } finally {
                  if (filterWrapper) filterWrapper.style.opacity = '1';
              }
          }

            // ==================================================
            // == MODAL & EVENT HANDLERS
            // ==================================================
            /** Sets up global modal close listeners and delegation for internal actions. */
            function setupModal() {
                // Close button within any modal
                 document.addEventListener('click', (e) => {
                    const closeBtn = e.target.closest('.modal .close');
                    if (closeBtn) {
                        const modalId = closeBtn.dataset.modalId || closeBtn.closest('.modal')?.id;
                        if (modalId) closeModalById(modalId);
                    }
                    // Close if clicking backdrop of a visible modal
                    else if (e.target.classList.contains('modal') && e.target.style.display === 'block') {
                         closeModalById(e.target.id);
                     }
                 });
                // Close with Escape key
                document.addEventListener('keydown', (e) => { if (e.key === "Escape") { const modals = document.querySelectorAll('.modal[style*="display: block"]'); if (modals.length > 0) closeModalById(modals[modals.length - 1].id); } });
                // Delegated listeners for actions *within* modals
                document.body.addEventListener('click', handleModalClicks);
                document.body.addEventListener('submit', handleModalFormSubmit);
                document.body.addEventListener('click', handleAuthFormSwitch);
            }

            /** Opens a specific modal by ID with title and content. */
            function showModal(modalId, title, content, isAuth = false) {
                const targetModal = document.getElementById(modalId);
                const targetTitle = targetModal?.querySelector('.modal-content h2'); // Generic title selector
                const targetBody = targetModal?.querySelector('.modal-content div[id$="Body"]'); // Generic body selector
                const targetContentElement = targetModal?.querySelector('.modal-content');

                if (!targetModal || !targetTitle || !targetBody || !targetContentElement) { console.error(`Cannot show modal - elements not found for ID: ${modalId}`); return; }
                targetTitle.innerHTML = title; // Use innerHTML for potential formatting
                targetBody.innerHTML = content; // Use innerHTML for content
                targetContentElement.classList.toggle('auth-modal', isAuth); // Apply auth class if needed
                targetModal.style.display = 'block';
                document.body.style.overflow = 'hidden'; // Prevent background scroll
            }

            /** Closes a specific modal by its ID. */
            function closeModalById(modalId) {
                const targetModal = document.getElementById(modalId);
                if (targetModal) targetModal.style.display = 'none';
                // Only restore body scroll if no other modals are visible
                const anyVisible = document.querySelector('.modal[style*="display: block"]');
                if (!anyVisible) document.body.style.overflow = '';
            }

            /** Handles clicks on specific interactive elements *inside* any open modal. */
            function handleModalClicks(e) {
                 // Allow default behavior for external links explicitly marked
                 const externalLink = e.target.closest('.try-now-modal, .docs-link-modal'); if (externalLink) return;

                 // Handle internal navigation links within modal
                 const navLinkModal = e.target.closest('.nav-link-modal');
                 if (navLinkModal?.getAttribute('href')?.startsWith('#')) {
                     e.preventDefault();
                     const targetId = navLinkModal.getAttribute('href');
                     document.querySelectorAll('.modal[style*="display: block"]').forEach(m => closeModalById(m.id)); // Close all open modals
                     const targetElement = document.querySelector(targetId);
                     if(targetElement) scrollToElement(targetElement); // Scroll to the target section
                     return;
                 }

                 // Handle "View Details" links for alternatives/matchmaker results within modal
                 const viewDetailsLink = e.target.closest('.view-details-matchmaker, .view-details-alternative');
                 if (viewDetailsLink) {
                     e.preventDefault();
                     const slug = viewDetailsLink.dataset.toolSlug;
                     const name = viewDetailsLink.dataset.toolName;
                     if (slug && name) {
                          // Simulate event object for handleViewDetails
                         const fakeEvent = { preventDefault: () => {}, target: viewDetailsLink };
                         handleViewDetails(fakeEvent); // Re-use the main details handler
                     }
                     return;
                 }

                 // Handle "Forgot Password" link (Demo)
                 if (e.target.matches('.modal-form-link') && e.target.textContent.toLowerCase().includes('forgot password')) {
                     e.preventDefault();
                     const currentFormMsg = e.target.closest('form')?.querySelector('[id$="FormMessage"]');
                     if (currentFormMsg) {
                         currentFormMsg.textContent = 'Forgot password link clicked (demo - not implemented).';
                         currentFormMsg.className = 'text-sm mb-3 text-blue-600'; // Use info color
                     } else {
                         showTemporaryMessage('Forgot password functionality not implemented.', 'info');
                     }
                     return;
                 }

                 // Handle click on signin/signup links within auth forms
                 const authSwitchLink = e.target.closest('.switch-to-signup, .switch-to-signin');
                 if(authSwitchLink) {
                    e.preventDefault();
                    if(authSwitchLink.classList.contains('switch-to-signup')) {
                         showModal('detailsModal', 'Sign Up', signUpContentHTML, true);
                    } else if(authSwitchLink.classList.contains('switch-to-signin')) {
                         showModal('detailsModal', 'Sign In', signInContentHTML, true);
                    }
                 }
             }

            /** Attaches event listeners to all tool cards currently in the grid. */
            function attachAllToolCardEvents(container) {
                if (!container) return;
                container.querySelectorAll('.tool-card .view-details').forEach(link => {
                    link.removeEventListener('click', handleViewDetails); // Remove old listener first
                    link.addEventListener('click', handleViewDetails);
                });
                 // Attach listeners for compare buttons as well
                container.querySelectorAll('.tool-card .add-compare-btn').forEach(btn => {
                    btn.removeEventListener('click', handleAddToCompareClick); // Remove old listener
                    btn.addEventListener('click', handleAddToCompareClick);
                });
                // Attach listeners for favorite buttons
                container.querySelectorAll('.tool-card .favorite-btn').forEach(btn => {
                    btn.removeEventListener('click', handleFavoriteClick); // Remove old listener
                    btn.addEventListener('click', handleFavoriteClick);
                });
            }

            /** Attaches event listener to a single tool card. */
            function attachSingleToolCardEvents(cardElement) {
                const detailsLink = cardElement?.querySelector('.view-details');
                if(detailsLink){ detailsLink.removeEventListener('click', handleViewDetails); detailsLink.addEventListener('click', handleViewDetails); }
                const compareBtn = cardElement?.querySelector('.add-compare-btn');
                if(compareBtn){ compareBtn.removeEventListener('click', handleAddToCompareClick); compareBtn.addEventListener('click', handleAddToCompareClick); }
                const favBtn = cardElement?.querySelector('.favorite-btn');
                if(favBtn){ favBtn.removeEventListener('click', handleFavoriteClick); favBtn.addEventListener('click', handleFavoriteClick); }
            }

             /** Handles clicks on 'Compare' buttons on tool cards. */
            function handleAddToCompareClick(e) {
                 e.preventDefault();
                 const btn = e.target.closest('.add-compare-btn');
                 if (!btn || btn.disabled) return;
                 const id = parseInt(btn.dataset.toolId, 10);
                 const name = btn.dataset.toolName;
                 if (!isNaN(id) && name) {
                     addToCompare(id, name);
                 }
            }

            /** Sets up delegated listener for news 'Read More' links. */
            function setupNewsGridDelegation() { newsGrid?.addEventListener('click', handleReadMoreNews); }

             /** Handles clicks on 'Read More', fetches full news content, displays in modal. */
            async function handleReadMoreNews(e) {
                const link = e.target.closest('.read-more'); if (!link) return;
                e.preventDefault(); const slug = link.dataset.newsSlug; const title = escapeHTML(link.dataset.newsTitle || 'News'); if (!slug) return;
                showModal('detailsModal', title, '<p class="p-4 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Loading article...</p>');
                try {
                    const res = await fetch(`${API_BASE_URL}/news/${slug}`); if (!res.ok) { const err = await res.json().catch(()=>{}); throw new Error(err?.error || `News fetch failed: ${res.statusText} (${res.status})`); } const article = await res.json();
                    // Basic sanitization (DOMPurify recommended for production)
                    let content = article.content ? article.content.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '') : '<p>Content not available.</p>';
                    // Markdown rendering placeholder (if needed)
                    // if (typeof marked !== 'undefined') { content = marked.parse(content); } else { content = content.replace(/\n/g, '<br>'); /* Basic newline handling */ }

                    const modalContent = `<article class="prose prose-indigo max-w-none">${content}</article><p class="text-sm text-gray-500 mt-4 pt-4 border-t">Published: ${article.published_date?new Date(article.published_date).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'}):'N/A'}${article.author?` by ${escapeHTML(article.author)}`:''}</p>`;
                    if(modalTitle) modalTitle.textContent = escapeHTML(article.title || title); // Update title with fetched title
                    if(modalBody) modalBody.innerHTML = modalContent;
                } catch(error) { console.error("News fetch error:", error); showModal('detailsModal', title, `<p class="text-red-500 p-4">Failed to load article. ${escapeHTML(error.message)}</p>`); }
            }

            // ==================================================
            // == LOAD MORE & FILTERING Setup
            // ==================================================
            /** Sets up event listeners for Load More buttons. */
            function setupLoadMoreButtons() { loadMoreToolsBtn?.addEventListener('click', handleLoadMoreTools); loadMoreNewsBtn?.addEventListener('click', handleLoadMoreNews); }
            /** Sets up event listeners for filter controls. */
            function setupFilterSortListeners() {
                if (!toolFilterControls) return; // Ensure the main filter container exists

                // Use event delegation on the filter controls container
                toolFilterControls.addEventListener('click', (e) => {
                    // Category Buttons
                    if (e.target.tagName === 'BUTTON' && e.target.closest('#toolFilterButtons')) {
                        if (!e.target.classList.contains('filter-button-active')) {
                            toolFilterButtonsContainer.querySelectorAll('button').forEach(btn => btn.classList.replace('filter-button-active', 'filter-button-inactive'));
                            e.target.classList.replace('filter-button-inactive', 'filter-button-active');
                            applyFiltersAndSearch(); // Trigger search/filter
                        }
                    }
                    // Clear Filters Button
                    else if (e.target.id === 'clearFiltersBtn' || e.target.closest('#clearFiltersBtn')) {
                        // Reset Category Buttons
                        toolFilterButtonsContainer?.querySelectorAll('button').forEach((btn, idx) => {
                            btn.classList.toggle('filter-button-active', idx === 0);
                            btn.classList.toggle('filter-button-inactive', idx !== 0);
                        });
                        // Reset other inputs/selects
                        if (toolSearchInput) toolSearchInput.value = '';
                        if (toolSortSelect) toolSortSelect.selectedIndex = 0;
                        if (pricingFilterSelect) pricingFilterSelect.selectedIndex = 0;
                        if (tagsFilterContainer) tagsFilterContainer.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                        clearFiltersFromLocalStorage(); // Clear saved filters
                        applyFiltersAndSearch(); // Trigger search/filter
                    }
                });

                // Handle changes in select dropdowns and tag checkboxes
                 toolFilterControls.addEventListener('change', (e) => {
                     if (e.target === toolSortSelect || e.target === pricingFilterSelect || e.target.closest('#tagsFilterContainer')) {
                         applyFiltersAndSearch();
                     }
                 });

                 // Handle search input with debouncing
                 toolSearchInput?.addEventListener('input', () => {
                     clearTimeout(searchDebounceTimeout);
                     searchDebounceTimeout = setTimeout(() => {
                         applyFiltersAndSearch();
                     }, 400); // Wait 400ms after user stops typing
                 });


                // --- News Filtering/Sorting Setup (Client-side) ---
                newsFilterButtonsContainer?.addEventListener('click', (e) => {
                    if (e.target.tagName === 'BUTTON' && !e.target.classList.contains('filter-button-active')) {
                        newsFilterButtonsContainer.querySelectorAll('button').forEach(b => b.classList.replace('filter-button-active','filter-button-inactive'));
                        e.target.classList.replace('filter-button-inactive','filter-button-active');
                        filterAndSortNews(); // Trigger client-side news filtering
                    }
                });
                newsSortSelect?.addEventListener('change', filterAndSortNews); // Trigger on sort change
            }

            /** Client-side filtering/sorting for News cards. */
            function filterAndSortNews() {
                if (!newsGrid || !allNewsCards) return;
                const selectedCategory = newsFilterButtonsContainer?.querySelector('.filter-button-active')?.dataset.filter || 'all';
                const sortValue = newsSortSelect?.value || 'latest';
                let visibleCount = 0;
                const msgId = 'no-results-news';
                let msgEl = document.getElementById(msgId); if(msgEl) msgEl.remove(); // Remove previous no results message

                // Filter based on category
                const filteredCards = allNewsCards.filter(card => {
                    const cardCategory = card.dataset.category?.toLowerCase() || 'general';
                    return selectedCategory === 'all' || cardCategory === selectedCategory;
                });

                // Sort the filtered cards
                filteredCards.sort((a, b) => {
                    switch (sortValue) {
                        case 'most_read': // Example: Sort by title length as proxy
                             return (b.querySelector('h3')?.textContent.length || 0) - (a.querySelector('h3')?.textContent.length || 0);
                        case 'featured': return 0; // Needs actual featured data - no sort for now
                        case 'latest':
                        default:
                             const dateA = new Date(a.dataset.date || 0).getTime();
                             const dateB = new Date(b.dataset.date || 0).getTime();
                             // Handle invalid dates, pushing them to the end
                             if (isNaN(dateB) && isNaN(dateA)) return 0;
                             if (isNaN(dateB)) return -1;
                             if (isNaN(dateA)) return 1;
                             return dateB - dateA; // Sort descending (latest first)
                    }
                });

                // Re-render the grid with sorted and filtered cards
                newsGrid.innerHTML = ''; // Clear the grid
                const fragment = document.createDocumentFragment();
                if (filteredCards.length > 0) {
                    filteredCards.forEach(card => {
                        card.classList.remove('hidden'); // Ensure visible
                        fragment.appendChild(card);
                        visibleCount++;
                    });
                } else {
                     // Show "No results" message only if a filter other than 'all' is active
                     if (selectedCategory !== 'all') {
                         const p = document.createElement('p'); p.id = msgId; p.className = 'col-span-full py-10 text-center text-gray-500'; p.textContent = 'No news articles match your filters.'; fragment.appendChild(p);
                    } else {
                        // If 'all' is selected and still no cards, it means allNewsCards was empty
                         const p = document.createElement('p'); p.id = msgId; p.className = 'col-span-full py-10 text-center text-gray-500'; p.textContent = 'No news articles found.'; fragment.appendChild(p);
                    }
                }
                newsGrid.appendChild(fragment);

                 // Update load more button state based on VISIBLE cards AFTER filtering/reordering
                updateLoadMoreButton('news', newsCurrentPage, totalNewsPages); // Call this AFTER filtering/reordering
            }

            // ==================================================
            // == COMPARISON TOOL (Tray Version)
            // ==================================================
            /** Sets up listeners for Add to Compare buttons and tray controls. */
            function setupComparisonTray() {
                // Event delegation for "Add Compare" buttons on cards is handled in attachAllToolCardEvents/attachSingleToolCardEvents
                // Listeners for controls within the tray itself
                comparisonTray?.addEventListener('click', (e) => {
                    const rmBtn = e.target.closest('.remove-compare-btn');
                    if (rmBtn) {
                        const id = parseInt(rmBtn.dataset.toolId, 10);
                        if (!isNaN(id)) removeFromCompare(id);
                    } else if (e.target === compareNowBtnTray || e.target.closest('#compareNowBtnTray')) {
                        handleCompareClick();
                    } else if (e.target === clearCompareBtnTray || e.target.closest('#clearCompareBtnTray')) {
                        clearComparison();
                    }
                });
            }

            /** Adds a tool to the comparison list and updates UI. */
            function addToCompare(toolId, toolName) {
                 if (isNaN(toolId) || !toolName) return; // Basic validation
                 if (comparisonList.some(i => i.id === toolId)) {
                    showTemporaryMessage(`${escapeHTML(toolName)} is already in the comparison list.`, 'info');
                    return;
                 }
                 if (comparisonList.length >= MAX_COMPARE_ITEMS) {
                    comparisonTray?.classList.add('shake'); // Add shake animation
                    setTimeout(() => comparisonTray?.classList.remove('shake'), 500);
                    showTemporaryMessage(`Cannot compare more than ${MAX_COMPARE_ITEMS} tools at a time.`, 'error');
                    return;
                 }
                 comparisonList.push({ id: toolId, name: toolName });
                 updateComparisonTray(); // Update UI elements
                 saveComparisonToLocalStorage(); // Persist
                 showTemporaryMessage(`${escapeHTML(toolName)} added to comparison.`, 'success');
            }

            /** Removes a tool from the comparison list. */
            function removeFromCompare(toolId) {
                 const tool = comparisonList.find(i => i.id === toolId);
                 comparisonList = comparisonList.filter(i => i.id !== toolId);
                 updateComparisonTray();
                 saveComparisonToLocalStorage();
                 if(tool) showTemporaryMessage(`${escapeHTML(tool.name)} removed from comparison.`, 'info');
                 else console.warn(`Tool ID ${toolId} not found in comparison list for removal.`);

                 // If removing items reduces list below 2, hide comparison results
                 if (comparisonList.length < 2) {
                     comparisonResultsDiv?.classList.add('hidden');
                     comparisonPlaceholder?.classList.remove('hidden');
                     if (currentPerformanceChart) currentPerformanceChart.destroy();
                 }
            }

            /** Clears the entire comparison list. */
            function clearComparison() {
                 comparisonList = [];
                 updateComparisonTray();
                 saveComparisonToLocalStorage();
                 // Hide comparison results section
                 comparisonResultsDiv?.classList.add('hidden');
                 comparisonPlaceholder?.classList.remove('hidden');
                 if (currentPerformanceChart) currentPerformanceChart.destroy();
                 showTemporaryMessage("Comparison list cleared.", "info");
            }

            /** Updates the comparison tray display based on comparisonList. */
            function updateComparisonTray() {
                 if (!comparisonTray || !comparisonTrayItems || !comparisonCount || !compareNowBtnTray) return;
                 // Clear existing items except the initial label
                 while (comparisonTrayItems.children.length > 1) {
                     comparisonTrayItems.removeChild(comparisonTrayItems.lastChild);
                 }
                 // Add current items
                 comparisonList.forEach(i => {
                     const el = document.createElement('div');
                     el.className = 'bg-gray-700 rounded px-2 py-1 flex items-center text-xs shrink-0';
                     el.innerHTML = `<span class="mr-1">${escapeHTML(i.name)}</span><button class="ml-1 text-gray-400 hover:text-white remove-compare-btn" data-tool-id="${i.id}" title="Remove">&times;</button>`;
                     comparisonTrayItems.appendChild(el);
                 });
                 // Update count and button states
                 comparisonCount.textContent = `(${comparisonList.length}/${MAX_COMPARE_ITEMS})`;
                 compareNowBtnTray.disabled = comparisonList.length < 2;
                 comparisonTray.classList.toggle('visible', comparisonList.length > 0);
                 comparisonTray.classList.toggle('hidden', comparisonList.length === 0);

                 // Update the "Add Compare" buttons on all visible tool cards
                 document.querySelectorAll('.tool-card:not(.hidden) .add-compare-btn').forEach(btn => {
                     const id = parseInt(btn.dataset.toolId, 10);
                     const inList = comparisonList.some(i => i.id === id);
                     // Disable if already in list OR if list is full (and this item is not already in it)
                     btn.disabled = inList || (comparisonList.length >= MAX_COMPARE_ITEMS);
                     btn.innerHTML = inList ? '<i class="fas fa-check text-green-500"></i> Added' : 'Compare';
                 });
            }

            /** Fetches data and displays the comparison table/chart. */
                    /** Fetches data and displays the comparison table/chart. */
         async function handleCompareClick() {
             if (comparisonList.length < 2) {
                 showTemporaryMessage("Select at least 2 tools to compare.", "info");
                 return;
              }
              const ids = comparisonList.map(i => i.id).join(',');
              const compSec = document.getElementById('comparison');
              const requestUrl = `${API_BASE_URL}/tools/compare?ids=${ids}`; // Construct URL

              console.log("Attempting to compare tools. Request URL:", requestUrl); // Log URL

              // Show loading state in comparison section
              comparisonResultsDiv?.classList.remove('hidden');
              comparisonPlaceholder?.classList.add('hidden');
              const tbody = comparisonTable?.querySelector('tbody');
              const thead = comparisonTable?.querySelector('thead tr');
              if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><i class="fas fa-spinner fa-spin mr-2"></i>Loading comparison...</td></tr>';
              if (thead) thead.innerHTML = '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10">Feature</th>'; // Reset headers
              if (currentPerformanceChart) currentPerformanceChart.destroy();

              if (compSec) scrollToElement(compSec);

              try {
                  const res = await fetch(requestUrl); // Use the constructed URL
                  console.log(`Compare fetch response status: ${res.status} ${res.statusText}`); // Log status

                  if (!res.ok) {
                      let errorDetails = `Server responded with status ${res.status}.`;
                      try {
                          // Try to get more specific error from JSON response
                          const err = await res.json();
                          errorDetails = err.error || JSON.stringify(err) || errorDetails;
                      } catch (e) {
                          // Ignore if response is not JSON
                      }
                      throw new Error(`Fetch Error: ${errorDetails}`);
                  }

                  const tools = await res.json();
                  console.log("Compare fetch response data:", tools); // Log the received data

                  if (!Array.isArray(tools)) {
                      throw new Error('Comparison API did not return an array.');
                  }
                  if (tools.length < 2) {
                      throw new Error('Comparison requires data for at least two tools. API returned fewer.');
                  }

                  updateComparisonTable(tools);
                  updatePerformanceChart(tools);

              } catch (error) {
                  console.error("Compare Error:", error); // Log the full error object
                  if (tbody) tbody.innerHTML = `<tr><td colspan="5" class="p-4 text-center text-red-500">Error loading comparison: ${escapeHTML(error.message)}</td></tr>`;
                  showTemporaryMessage(`Error loading comparison: ${escapeHTML(error.message)}`, 'error');
                  // Keep results div visible to show the error message in the table
                  // comparisonResultsDiv?.classList.add('hidden');
                  // comparisonPlaceholder?.classList.remove('hidden');
              }
         }

             /** Renders the comparison table with enhanced features. */
                         /**
             * Renders the comparison table based on the fetched tool data.
             * @param {Array<Object>} tools - An array of tool objects fetched from the comparison API.
             */
             function updateComparisonTable(tools) {
                 console.log("Updating comparison table with data:", tools); // Log input data
                 if (!comparisonTable || !tools || !Array.isArray(tools) || tools.length === 0) {
                     console.error("Cannot update comparison table: Invalid input or table element not found.");
                     // Display message in the table body if possible
                     const tbody = comparisonTable?.querySelector('tbody');
                     if (tbody) tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">Error: Invalid data received for comparison.</td></tr>';
                     return;
                 }
                 const thead = comparisonTable.querySelector('thead tr');
                 const tbody = comparisonTable.querySelector('tbody');
                 if (!thead || !tbody) {
                     console.error("Cannot update comparison table: thead or tbody not found.");
                     return;
                 }

                 // Clear previous content
                 thead.innerHTML = '<th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase sticky left-0 bg-gray-50 z-10">Feature</th>';
                 tbody.innerHTML = '';

                 // Add tool name headers
                 tools.forEach(t => {
                     const th = document.createElement('th');
                     th.scope = 'col';
                     th.className = 'px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase min-w-[150px]';
                     // Use tool name, fallback to slug or ID if name is missing
                     th.textContent = escapeHTML(t.name || t.slug || `Tool ID ${t.id}`);
                     thead.appendChild(th);
                 });

                 // --- Define features and rendering logic ---
                 // !!!!! ========================================================== !!!!!
                 // !!!!! CRITICAL: Verify these 'key' values EXACTLY match your API !!!!!
                 // !!!!! response structure. Check nested keys carefully.         !!!!!
                 // !!!!! Use Browser Network Tab to inspect the response from       !!!!!
                 // !!!!! /api/tools/compare?ids=...                               !!!!!
                 // !!!!! ========================================================== !!!!!
                 const featureDefinitions = [
                    // Key: API key, Name: Display Name, Type: Data type hint, Highlight: 'highest'/'lowest'/'lowest_nonzero'
                    { key: 'rating_avg', name: 'Rating', type: 'rating', highlight: 'highest' },
                    { key: 'review_count', name: 'Reviews', type: 'number', highlight: 'highest' },
                    { key: 'category_name', name: 'Category', type: 'text' },
                    { key: 'pricing_text', name: 'Pricing Model', type: 'text' },
                    { key: 'pricing_low', name: 'Starts ($/mo)', type: 'price', highlight: 'lowest_nonzero' }, // Example: Assumes 'pricing_low' key exists
                    { key: 'features_json.API Access', name: 'API Access', type: 'boolean' }, // Example: Assumes nested 'features_json' with 'API Access' key
                    { key: 'features_json.Context Window', name: 'Context Window', type: 'text_numeric', highlight: 'highest' }, // Example: Assumes nested structure
                    { key: 'tags_array', name: 'Tags', type: 'tags' } // Assumes 'tags_array' is an array of strings
                    // Add more features here based on your API data structure
                 ];

                 featureDefinitions.forEach(fDef => {
                     const row = tbody.insertRow();
                     const featureCell = row.insertCell();
                     featureCell.className = 'px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky left-0 bg-white z-10 align-top';
                     featureCell.textContent = fDef.name;

                     // Extract values for this feature from all tools
                     let values = tools.map(tool => {
                         let value;
                         // Safely access nested properties
                         if (fDef.key.includes('.')) {
                             try {
                                 // Navigate through nested keys
                                 value = fDef.key.split('.').reduce((o, k) => {
                                     // Check if intermediate object 'o' exists and key 'k' is present
                                     if (o && typeof o === 'object' && k in o && o[k] !== undefined && o[k] !== null) {
                                         return o[k];
                                     }
                                     return undefined; // Stop reducing if path breaks
                                 }, tool);
                             } catch (e) {
                                 value = undefined; // Handle potential errors during reduce
                                 console.warn(`Error accessing nested key "${fDef.key}" for tool ID ${tool.id}:`, e);
                             }
                         } else {
                             value = tool[fDef.key]; // Access top-level key
                         }
                         // Ensure value is not null before returning, default to undefined if it is
                         return { value: (value !== null ? value : undefined), id: tool.id };
                     });


                     // --- Determine Best Value for Highlighting ---
                     let bestValue = null;
                     let bestIds = new Set();
                     if (fDef.highlight) {
                         const numericValues = values
                             .map(item => {
                                 let numericVal = -Infinity; // Default for non-comparable
                                 if (item.value !== null && item.value !== undefined) {
                                     if (fDef.type === 'price') {
                                         // Handle 'Free' text or numeric 0 as 0, otherwise parse price, default to Infinity
                                         if(String(item.value).toLowerCase() === 'free' || item.value === 0) numericVal = 0;
                                         else numericVal = parseFloat(String(item.value).replace(/[^0-9.]/g, '')) || Infinity;
                                     } else if (fDef.type === 'rating' || fDef.type === 'number' || fDef.type === 'text_numeric') {
                                         // Extract number, handle non-numeric as -Infinity
                                         numericVal = parseFloat(String(item.value).replace(/[^0-9.-]/g, '')) || -Infinity;
                                     }
                                 }
                                 return { ...item, numeric: numericVal };
                             })
                             .filter(item => item.numeric !== -Infinity && item.numeric !== Infinity); // Filter out non-comparable defaults

                         if (numericValues.length > 0) {
                             if (fDef.highlight === 'highest') {
                                 bestValue = Math.max(...numericValues.map(item => item.numeric));
                             } else if (fDef.highlight === 'lowest_nonzero') {
                                 const nonZeroNums = numericValues.filter(item => item.numeric > 0);
                                 bestValue = nonZeroNums.length > 0 ? Math.min(...nonZeroNums.map(item => item.numeric)) : Math.min(...numericValues.map(item => item.numeric));
                             } else if (fDef.highlight === 'lowest') {
                                 bestValue = Math.min(...numericValues.map(item => item.numeric));
                             }

                             // Find IDs matching the best value (handle potential floating point issues)
                             const tolerance = 0.001;
                             if (bestValue !== null) {
                                 numericValues.forEach(item => {
                                     if (Math.abs(item.numeric - bestValue) < tolerance) {
                                         bestIds.add(item.id);
                                     }
                                 });
                             }
                         }
                     }

                     // --- Render Cells for Each Tool ---
                     values.forEach(({ value: v, id }) => {
                         const dataCell = row.insertCell();
                         dataCell.className = 'px-6 py-4 whitespace-normal text-sm text-gray-500 align-top';
                         let cellHTML = '';

                         // Apply highlight class if this tool's ID matches best
                         if (bestIds.has(id)) {
                             dataCell.classList.add('bg-green-50', 'font-semibold', 'text-green-800');
                         }

                         // Format cell content based on type
                         if (v === null || v === undefined) {
                             cellHTML = '<span class="text-gray-400">N/A</span>';
                         } else if (fDef.type === 'rating') {
                             const n = parseFloat(v);
                             cellHTML = `${generateStars(n)} <span class="ml-1">(${!isNaN(n) ? n.toFixed(1) : 'N/A'})</span>`;
                         } else if (fDef.type === 'tags' && Array.isArray(v)) {
                             cellHTML = v.length > 0 ? v.slice(0, 5).map(t => `<span class="inline-block bg-gray-100 text-gray-800 text-xs px-2 py-0.5 rounded mr-1 mb-1">${escapeHTML(t)}</span>`).join('') + (v.length > 5 ? ' ...' : '') : '<span class="text-gray-400">None</span>';
                         } else if (fDef.type === 'boolean') {
                             // Strict check for boolean true
                             cellHTML = v === true ? '<i class="fas fa-check text-green-500 mr-1"></i> Yes' : '<i class="fas fa-times text-red-500 mr-1"></i> No';
                             dataCell.classList.add('text-center');
                         } else if (fDef.type === 'price') {
                             const priceNum = parseFloat(v);
                             if (String(v).toLowerCase() === 'free' || v === 0) {
                                 cellHTML = 'Free';
                             } else if (!isNaN(priceNum)) {
                                 cellHTML = `$${priceNum.toFixed(2)}`;
                             } else {
                                 // Display text if not 'Free' or a number (e.g., "Contact Us", "Custom")
                                 cellHTML = escapeHTML(String(v));
                             }
                         } else if (fDef.type === 'number') {
                             const num = parseFloat(v);
                             cellHTML = !isNaN(num) ? num.toLocaleString() : escapeHTML(String(v));
                         } else if (fDef.type === 'text_numeric') {
                             // Display raw text, but it was parsed for highlighting
                             cellHTML = escapeHTML(String(v));
                         } else { // Default: treat as plain text
                             const s = String(v);
                             cellHTML = s.length > 100 ? escapeHTML(s.substring(0, 97)) + '...' : escapeHTML(s);
                             dataCell.title = s; // Full text on hover
                         }

                         dataCell.innerHTML = cellHTML;
                     });
                 });
                 console.log("Comparison table updated successfully.");
             }

            /**
             * Renders the comparison performance chart using Chart.js.
             * @param {Array<Object>} tools - An array of tool objects fetched from the comparison API.
             */
             function updatePerformanceChart(tools) {
                 console.log("Updating comparison chart with data:", tools);
                  if (!performanceChartCanvas || typeof Chart === 'undefined') {
                      console.warn("Cannot update performance chart: Canvas not found or Chart.js not loaded.");
                      return;
                  }
                  const ctx = performanceChartCanvas.getContext('2d');
                  if (!ctx) {
                       console.error("Cannot get 2D context for performance chart canvas.");
                       return;
                  }

                  // Destroy previous chart instance if it exists
                  if (currentPerformanceChart) {
                      currentPerformanceChart.destroy();
                      currentPerformanceChart = null;
                  }

                  // Prepare labels and data for the chart
                  const chartLabels = tools.map(t => {
                      const name = t.name || t.slug || `Tool ID ${t.id}`;
                      return name.length > 15 ? name.substring(0, 12) + '...' : name;
                  });
                  // Use rating_avg, default to 0 if null, undefined, or not a number
                  const chartDataValues = tools.map(tool => {
                      const rating = parseFloat(tool?.rating_avg);
                      return !isNaN(rating) ? rating : 0;
                  });

                  // Define chart data structure
                  const chartData = {
                      labels: chartLabels,
                      datasets: [{
                          label: 'Avg Rating (/5)',
                          data: chartDataValues,
                          backgroundColor: [
                              'rgba(59, 130, 246, 0.6)', 'rgba(139, 92, 246, 0.6)',
                              'rgba(16, 185, 129, 0.6)', 'rgba(234, 179, 8, 0.6)'
                          ].slice(0, tools.length),
                          borderColor: [
                              'rgba(59, 130, 246, 1)', 'rgba(139, 92, 246, 1)',
                              'rgba(16, 185, 129, 1)', 'rgba(234, 179, 8, 1)'
                          ].slice(0, tools.length),
                          borderWidth: 1
                      }]
                  };

                  // Define chart options
                  const chartOptions = {
                      indexAxis: tools.length > 4 ? 'y' : 'x', // Use y-axis if more than 4 tools
                      responsive: true,
                      maintainAspectRatio: false,
                      scales: {}, // Initialize scales object
                      plugins: {
                          legend: { display: false },
                          tooltip: {
                              callbacks: {
                                  title: (tooltipItems) => {
                                      const dataIndex = tooltipItems[0]?.dataIndex;
                                      return (dataIndex !== undefined && tools[dataIndex]) ? (tools[dataIndex].name || tools[dataIndex].slug || `Tool ID ${tools[dataIndex].id}`) : '';
                                  },
                                  label: (context) => {
                                      let label = context.dataset.label || '';
                                      if (label) label += ': ';
                                      const value = context.parsed.y ?? context.parsed.x;
                                      label += (value !== null && value !== undefined) ? value.toFixed(1) : 'N/A';
                                      return label;
                                  }
                              }
                          }
                      }
                  };

                   // Define scales based on indexAxis
                   if (chartOptions.indexAxis === 'y') {
                       chartOptions.scales = {
                            x: { // Value axis (horizontal)
                                beginAtZero: true,
                                max: 5,
                                title: { display: true, text: 'Average Rating' }
                            },
                            y: { // Category axis (vertical)
                                ticks: { mirror: false } // Adjust ticks if needed
                            }
                       };
                   } else { // indexAxis is 'x' (default)
                       chartOptions.scales = {
                            y: { // Value axis (vertical)
                                beginAtZero: true,
                                max: 5,
                                title: { display: true, text: 'Average Rating' }
                             },
                            x: { // Category axis (horizontal)
                                ticks: { maxRotation: 0, minRotation: 0 }
                            }
                       };
                   }

                  // Create the new chart instance
                  try {
                       currentPerformanceChart = new Chart(ctx, {
                           type: 'bar',
                           data: chartData,
                           options: chartOptions
                       });
                       console.log("Performance chart updated successfully.");
                  } catch (chartError) {
                      console.error("Failed to create performance chart:", chartError);
                      ctx.clearRect(0, 0, performanceChartCanvas.width, performanceChartCanvas.height);
                      ctx.fillStyle = 'red'; ctx.font = '14px Inter'; ctx.textAlign = 'center';
                      ctx.fillText('Error rendering chart.', performanceChartCanvas.width / 2, performanceChartCanvas.height / 2);
                  }
             }
            // ==================================================
            // == AI MATCHMAKER (Backend Version)
            // ==================================================
            function setupMatchmakerForm() { matchmakerForm?.addEventListener('submit', handleMatchmakerSubmit); }
            async function handleMatchmakerSubmit(e) {
                e.preventDefault(); const form = e.target;
                const btn = form.querySelector('button[type="submit"]');
                const criteria = Object.fromEntries(new FormData(form).entries());
                let isValid = true;

                // Basic validation
                const useCaseSelect = document.getElementById('useCaseSelect');
                if (!criteria.useCase) { useCaseSelect?.classList.add('border-red-500', 'ring-red-500'); isValid = false; }
                else { useCaseSelect?.classList.remove('border-red-500', 'ring-red-500'); }
                // Add validation for other required fields if necessary

                if (!isValid) { showTemporaryMessage('Please select your primary use case.', 'error'); return; }
                if (matchmakerLoading) matchmakerLoading.classList.remove('hidden');
                if (btn) btn.disabled = true;

                try {
                    console.log("Submitting matchmaker criteria:", criteria);
                    const res = await fetch(`${API_BASE_URL}/matchmaker`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(criteria) });
                    if (!res.ok) { const err = await res.json().catch(() => ({})); throw new Error(err.error || `Server Error: ${res.statusText} (${res.status})`); }
                    const { recommendations = [] } = await res.json();
                    console.log("Matchmaker recommendations received:", recommendations);

                    let resultsHTML = `<div class='space-y-4'><p class='text-lg font-semibold mb-3'>Top Matches based on your criteria:</p>`;
                    if (recommendations.length > 0) {
                        resultsHTML += '<div class="grid grid-cols-1 gap-4">';
                        recommendations.forEach(t => {
                            const stars = generateStars(t.rating_avg);
                            // Use a placeholder image or the actual image_url if available from the backend
                            const imgUrl = escapeHTML(t.image_url || `https://via.placeholder.com/40x40/E2E8F0/4A5568?text=${escapeHTML(t.name?.[0] || 'A')}`);
                             resultsHTML += `
                                <div class="border rounded-lg p-4 flex items-start space-x-3 bg-white shadow-sm">
                                    <img loading="lazy" src="${imgUrl}" alt="${escapeHTML(t.name)}" class="w-10 h-10 rounded-md shrink-0 object-cover">
                                    <div class="flex-grow min-w-0">
                                        <h4 class="font-semibold text-gray-800 truncate">
                                            <a href="#" class="text-indigo-600 hover:underline view-details-matchmaker" data-tool-slug="${escapeHTML(t.slug)}" data-tool-name="${escapeHTML(t.name)}">${escapeHTML(t.name)}</a>
                                        </h4>
                                        <p class="text-xs text-gray-500 mb-1">${escapeHTML(t.category_name||'')}</p>
                                        <div class="flex items-center text-xs mb-1" title="Avg Rating: ${t.rating_avg ? parseFloat(t.rating_avg).toFixed(1) : 'N/A'}">
                                            ${stars}<span class="ml-1 text-gray-500">(${t.review_count||0})</span>
                                        </div>
                                        <p class="text-xs text-gray-600 line-clamp-2 mb-1">${escapeHTML(t.description||'')}</p>
                                        <p class="text-xs font-medium text-gray-700">${escapeHTML(t.pricing_text||'N/A')}</p>
                                    </div>
                                </div>`;
                         });
                        resultsHTML += '</div>';
                    } else { resultsHTML += `<p class="text-center text-gray-600 py-4">No specific matches found. Try adjusting criteria or <a href='#tools' class='text-indigo-600 hover:underline nav-link-modal'>browse the directory</a>.</p>`; }
                    resultsHTML += "<hr class='my-4'><p class='text-sm text-gray-500'>Use the <a href='#comparison' class='text-indigo-600 hover:underline nav-link-modal'>Compare Tool</a> (via the tray below) for side-by-side analysis.</p></div>";

                    showModal('detailsModal', 'Matchmaker Results', resultsHTML); // Show results in the main modal

                } catch (error) {
                     console.error("Matchmaker error:", error);
                     showModal('detailsModal', 'Matchmaker Error', `<p class="text-red-500">Could not find matches: ${escapeHTML(error.message)}</p>`);
                } finally {
                     if (matchmakerLoading) matchmakerLoading.classList.add('hidden');
                     if (btn) btn.disabled = false;
                 }
            }

            // ==================================================
            // == Authentication & User State
            // ==================================================
            /** Updates navbar/mobile menu and elements requiring auth based on login state */
            function updateAuthUI() {
                const token = localStorage.getItem('authToken'); const name = escapeHTML(localStorage.getItem('userName')); const loggedIn = !!(token && name);
                console.log("Updating Auth UI, loggedIn:", loggedIn, "Name:", name);

                // Desktop Nav Auth Area
                if (authStatusContainer) {
                    authStatusContainer.innerHTML = loggedIn ? `
                        <span class="text-sm text-gray-700 mr-3 hidden md:inline">Welcome, ${name}!</span>
                        <button id="logoutBtnDesktop" class="bg-red-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:bg-red-700">Logout</button>
                    ` : `
                        <button id="signInBtnDesktop" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white px-4 py-2 rounded-md text-sm font-medium hover:opacity-90">Sign In / Sign Up</button>
                    `;
                    // Re-attach listeners after innerHTML change
                    authStatusContainer.querySelector('#logoutBtnDesktop')?.addEventListener('click', handleLogout);
                    authStatusContainer.querySelector('#signInBtnDesktop')?.addEventListener('click', showAuthModal);
                }

                // Mobile Nav Auth Area
                if (authStatusContainerMobile) {
                    authStatusContainerMobile.innerHTML = loggedIn ? `
                        <div class="text-center mb-2"><span class="text-base font-medium text-gray-800 block">Welcome, ${name}!</span></div>
                        <button id="logoutBtnMobile" class="w-full bg-red-100 text-red-700 px-4 py-2 rounded-md text-base font-medium hover:bg-red-200 border border-red-200">Logout</button>
                    ` : `
                        <button id="signInBtnMobile" class="w-full py-2 text-base font-medium text-gray-500 hover:text-gray-800 hover:bg-gray-100 rounded-md text-center border border-gray-300">Sign In / Sign Up</button>
                    `;
                     // Re-attach listeners after innerHTML change
                     authStatusContainerMobile.querySelector('#logoutBtnMobile')?.addEventListener('click', handleLogout);
                     authStatusContainerMobile.querySelector('#signInBtnMobile')?.addEventListener('click', () => { closeMobileMenu(); showAuthModal(); });
                }

                // Show/Hide elements requiring authentication
                document.querySelectorAll('.requires-auth').forEach(el => {
                    el.style.display = loggedIn ? '' : 'none'; // Use style.display for elements potentially inside modals etc.
                });
                if (showSubmitToolModalBtn) {
                    showSubmitToolModalBtn.style.display = loggedIn ? 'inline-block' : 'none';
                }

                // Update favorite buttons visibility and state
                updateFavoriteButtonsUI();
            }

            /** Logs the user out, clears storage, updates UI */
            function handleLogout() {
                 console.log('Logging out user...');
                 localStorage.removeItem('authToken');
                 localStorage.removeItem('userName');
                 userFavorites.clear(); // Clear client-side favorites
                 comparisonList = []; // Clear comparison list on logout
                 saveComparisonToLocalStorage(); // Persist cleared comparison
                 updateAuthUI(); // Update navbars
                 updateComparisonTray(); // Update tray display
                 showTemporaryMessage('Logged out successfully.', 'success');
                 // Optional: Reload page for a clean state, or re-fetch initial data
                 // window.location.reload();
                 fetchAndRenderInitialData(); // Re-fetch data to show public state
            }

            /** Opens the Sign In modal */
            function showAuthModal() { showModal('detailsModal', 'Sign In', signInContentHTML, true); }

            /** Handles clicks on 'Sign Up'/'Sign In' links within auth modals */
            function handleAuthFormSwitch(e) {
                // This is now handled within handleModalClicks for simplicity
            }

            /** Handles form submissions within any modal */
            async function handleModalFormSubmit(e) {
                 const form = e.target;
                 if (form.id === 'modalReviewForm') { e.preventDefault(); await handleReviewSubmit(form); }
                 else if (form.id === 'signInForm' || form.id === 'signUpForm') { e.preventDefault(); await handleAuthSubmit(form); }
                 else if (form.id === 'submitToolForm') { e.preventDefault(); await handleSubmitToolForm(form); }
             }

            /** Handles Review form submission */
            async function handleReviewSubmit(form) {
                 const toolId=form.dataset.toolId; const rating=form.querySelector('input[name="rating"]:checked')?.value; const text=form.querySelector('textarea[name="reviewText"]').value; const msgEl=form.querySelector('#reviewFormMessage'); const btn=form.querySelector('button[type="submit"]'); if(!msgEl || !btn || !toolId) return; if(!rating){msgEl.textContent='Please select a rating.';msgEl.className='text-sm mb-3 text-red-600';return;} const token=localStorage.getItem('authToken');if(!token){msgEl.textContent='Sign in required to submit review.';msgEl.className='text-sm mb-3 text-red-600'; return;}
                 btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';msgEl.textContent='';
                 try{const res=await fetch(`${API_BASE_URL}/tools/${toolId}/reviews`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify({rating:parseInt(rating),reviewText:text})});const result=await res.json();if(!res.ok)throw new Error(result.error||`Server Error: ${res.status}`);msgEl.textContent=result.message||'Review submitted successfully!';msgEl.className='text-sm mb-3 text-green-600';form.reset();const starInput=form.querySelector('.star-rating-input');if(starInput)starInput.dataset.ratingValue="0";setupStarRatingInput();showTemporaryMessage('Review submitted!', 'success'); setTimeout(async ()=>{ /* Optionally close modal and refresh */ closeModalById('detailsModal'); await applyFiltersAndSearch(); /* Refresh grid to show updated review counts/ratings */}, 1500);}catch(error){console.error("Review submit error:",error);msgEl.textContent=`Error: ${escapeHTML(error.message)}`;msgEl.className='text-sm mb-3 text-red-600';if(String(error.message).includes('401')||String(error.message).includes('403')||String(error.message).includes('Unauthorized'))handleLogout(); /* Log out if token is invalid */}finally{btn.disabled=false;btn.innerHTML='Submit Review';}
             }

            /** Handles Sign In / Sign Up form submission */
            async function handleAuthSubmit(form) {
                 const id=form.id; const data=Object.fromEntries(new FormData(form).entries()); const msgEl=form.querySelector('#signInFormMessage, #signUpFormMessage'); let url='',okMsg='',errMsg=''; if(!msgEl) return;
                 const btn=form.querySelector('button[type="submit"]'); const btnTxt=btn?.innerHTML;
                 // Client-side validation
                 if(id==='signUpForm'){url=`${API_BASE_URL}/auth/register`;okMsg='Account created! Please Sign In.';errMsg='Sign up failed';if(!data.name||!data.email||!data.password||!data.confirmPassword){msgEl.textContent='Please fill all required fields.';return;}if(data.password!==data.confirmPassword){msgEl.textContent='Passwords do not match.';return;}if(data.password.length<6){msgEl.textContent='Password must be at least 6 characters.';return;}delete data.confirmPassword;}else if(id==='signInForm'){url=`${API_BASE_URL}/auth/login`;okMsg='Sign in successful!';errMsg='Sign in failed';if(!data.email||!data.password){msgEl.textContent='Please enter email and password.';return;}}else return;

                 if(btn){btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';}msgEl.textContent='';
                 try{const res=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await res.json();if(!res.ok)throw new Error(result.error||`Server Error: ${res.statusText} (${res.status})`);
                     if(id==='signInForm'&&result.token){ // Handle successful sign in
                         localStorage.setItem('authToken',result.token);
                         localStorage.setItem('userName',result.user?.name||'User');
                         await fetchUserFavorites(); // Fetch favorites immediately after login
                         updateAuthUI(); // Update navbars etc.
                         closeModalById('detailsModal'); // Close the auth modal
                         showTemporaryMessage(result.message||okMsg,'success');
                         await applyFiltersAndSearch(); // Refresh tool grid to show favorite icons correctly
                     } else if (id==='signUpForm') { // Handle successful sign up
                         showModal('detailsModal','Sign In',signInContentHTML,true); // Switch to sign-in modal
                         // Add success message to the new sign-in modal form
                         const newMsgEl = document.getElementById('signInFormMessage');
                         if(newMsgEl) {
                             newMsgEl.textContent = result.message || okMsg;
                             newMsgEl.className = 'text-sm mb-3 text-green-600'; // Use green for success
                         } else {
                             showTemporaryMessage(result.message||okMsg,'success'); // Fallback popup
                         }
                     }
                 }catch(error){console.error(`${errMsg}:`,error);msgEl.textContent=error.message;}finally{if(btn){btn.disabled=false;btn.innerHTML=btnTxt;}}
            }

            // ==================================================
            // == FAVORITE Functions
            // ==================================================
            /** Fetches favorite tool IDs for the logged-in user */
            async function fetchUserFavorites() {
                const token = localStorage.getItem('authToken'); if (!token) { userFavorites.clear(); return; } console.log("Fetching user favorites...");
                try { const res = await fetch(`${API_BASE_URL}/users/me/favorites`, { headers: { 'Authorization': `Bearer ${token}` } }); if (!res.ok) { if (res.status === 401 || res.status === 403) { console.warn("Unauthorized fetching favorites, logging out."); handleLogout(); } throw new Error(`Fav fetch fail: ${res.statusText} (${res.status})`); } const data = await res.json(); userFavorites = new Set(data.favoriteToolIds || []); console.log('User favorites loaded:', userFavorites); } catch (e) { console.error("Fetch fav error:", e); userFavorites.clear(); }
            }

            /** Sets up delegated listener for favorite buttons */
            function setupFavoriteButtonListener() {
                // Delegation is handled via attachAllToolCardEvents and modal rendering
            }

            /** Handles clicks on favorite buttons (event delegation handled elsewhere) */
            async function handleFavoriteClick(e) {
                const favButton = e.target.closest('.favorite-btn'); if (!favButton) return;
                const token = localStorage.getItem('authToken'); if (!token) { showAuthModal(); return; } const toolId = parseInt(favButton.dataset.toolId, 10); if (isNaN(toolId)) return;

                const isCurrentlyFavorited = userFavorites.has(toolId); const method = isCurrentlyFavorited ? 'DELETE' : 'POST'; const url = `${API_BASE_URL}/tools/${toolId}/favorite`;
                const icon = favButton.querySelector('i'); favButton.disabled = true; // Disable during request

                try { // --- Optimistic UI Update ---
                    favButton.classList.toggle('favorited', !isCurrentlyFavorited);
                    if (icon) { icon.classList.replace(isCurrentlyFavorited ? 'fas' : 'far', isCurrentlyFavorited ? 'far' : 'fas'); }
                    favButton.title = isCurrentlyFavorited ? 'Add favorite' : 'Remove favorite';
                    if (isCurrentlyFavorited) userFavorites.delete(toolId); else userFavorites.add(toolId);
                    // -----------------------------

                    const res = await fetch(url, { method: method, headers: { 'Authorization': `Bearer ${token}` } });
                    if (!res.ok) {
                        const err = await res.json().catch(() => ({ error: `Server Error (${res.status})` }));
                        throw new Error(err.error || `Fav update failed: ${res.statusText} (${res.status})`);
                    }
                    const result = await res.json();
                    console.log(`Favorite ${isCurrentlyFavorited ? 'removed' : 'added'} for tool ${toolId}`, result);
                    // showTemporaryMessage(result.message || `Favorite ${isCurrentlyFavorited ? 'removed' : 'added'}!`, 'success'); // Optional success message

                } catch (error) {
                    console.error('Favorite Error:', error);
                    // --- Revert Optimistic UI on error ---
                    if (isCurrentlyFavorited) userFavorites.add(toolId); else userFavorites.delete(toolId); // Revert state
                    favButton.classList.toggle('favorited', isCurrentlyFavorited); // Revert class
                    if (icon) { icon.classList.replace(isCurrentlyFavorited ? 'far' : 'fas', isCurrentlyFavorited ? 'fas' : 'far'); } // Revert icon
                    favButton.title = isCurrentlyFavorited ? 'Remove favorite' : 'Add favorite'; // Revert title
                    // --- Show Error Message ---
                    showTemporaryMessage(`Error updating favorite: ${escapeHTML(error.message)}`, 'error');
                    if (String(error.message).includes('401') || String(error.message).includes('403') || String(error.message).includes('Unauthorized')) handleLogout(); // Logout if unauthorized
                } finally {
                    favButton.disabled = false; // Re-enable button
                }
            }

            /** Updates the appearance of all favorite buttons on the page */
            function updateFavoriteButtonsUI() {
                const isLoggedIn = !!localStorage.getItem('authToken');
                document.querySelectorAll('.favorite-btn').forEach(btn => {
                    const id = parseInt(btn.dataset.toolId, 10);
                    const isFav = userFavorites.has(id);
                    const icon = btn.querySelector('i');
                    btn.style.display = isLoggedIn ? '' : 'none'; // Show/hide based on login
                    btn.classList.toggle('favorited', isFav);
                    btn.title = isFav ? 'Remove favorite' : 'Add favorite';
                    if (icon) {
                        icon.classList.toggle('fas', isFav); // Solid heart if favorited
                        icon.classList.toggle('far', !isFav); // Regular heart if not
                    }
                });
            }

            // ==================================================
            // == TOOL SUBMISSION Functions
            // ==================================================
            /** Sets up listener for the submit tool modal button */
            function setupSubmitToolModal() {
                showSubmitToolModalBtn?.addEventListener('click', () => {
                    if (!localStorage.getItem('authToken')) {
                        showAuthModal(); // Require login
                        return;
                    }
                    populateAndShowSubmitModal(); // Show the form
                });
                // Close button listener for the submit modal specifically
                submitToolModal?.querySelector('.close')?.addEventListener('click', () => closeModalById('submitToolModal'));
            }

            /** Populates and displays the tool submission modal */
            function populateAndShowSubmitModal() {
                // Define categories dynamically or use a static list if backend doesn't provide it
                const categories = [
                     { slug:'text-ai', name:'Text AI' }, { slug:'image-ai', name:'Image AI' },
                     { slug:'code-ai', name:'Code AI' }, { slug:'video-ai', name:'Video AI' },
                     { slug:'audio-ai', name:'Audio AI' }, { slug:'utility-ai', name:'Utility AI' },
                     { slug:'other', name:'Other' } // Add an 'Other' category
                ];
                const formHTML = `
                <form id="submitToolForm">
                    <p class="text-sm text-gray-600 mb-4">Submit a new AI tool for inclusion in the directory. It will be reviewed before appearing.</p>
                    <div class="mb-4"><label for="sTName" class="l">Tool Name*</label><input type="text" id="sTName" name="name" required class="input-field"></div>
                    <div class="mb-4"><label for="sTUrl" class="l">Website URL*</label><input type="url" id="sTUrl" name="website_url" required placeholder="https://..." class="input-field"></div>
                    <div class="mb-4 relative"><label for="sTCat" class="l">Category*</label>
                        <select id="sTCat" name="category_slug" required class="input-field appearance-none bg-white pr-8">
                            <option value="">Select...</option>
                            ${categories.map(c=>`<option value="${c.slug}">${escapeHTML(c.name)}</option>`).join('')}
                        </select>
                        <i class="fas fa-chevron-down absolute right-3 top-1/2 transform translate-y-[-0.75rem] text-gray-400 pointer-events-none"></i>
                    </div>
                    <div class="mb-4"><label for="sTDesc" class="l">Short Description*</label><textarea id="sTDesc" name="description" rows="3" required class="input-field" maxlength="200"></textarea></div>
                    <div class="mb-4"><label for="sTPricing" class="l">Pricing (e.g., Free, $10/mo)</label><input type="text" id="sTPricing" name="pricing_text" placeholder="Free, Freemium, $10 - $50/mo" class="input-field"></div>
                    <div class="mb-4"><label for="sTTags" class="l">Tags (comma-separated)</label><input type="text" id="sTTags" name="tags" placeholder="creative, writing, developer" class="input-field"></div>
                    <div id="submitToolFormMessage" class="text-sm mb-3"></div>
                    <button type="submit" class="w-full btn-primary">Submit for Review</button>
                </form>
                <style>.l{display:block;font-size:0.875rem;font-weight:500;color:#374151;margin-bottom:0.25rem;}</style>`;

                if (submitToolModalBody) {
                    submitToolModalBody.innerHTML = formHTML;
                    showModal('submitToolModal', 'Submit AI Tool', ''); // Content is set, just display the modal shell
                } else { console.error("submitToolModalBody element not found!"); }
            }

            /** Handles the submission of the tool form */
            async function handleSubmitToolForm(form) {
                const data=Object.fromEntries(new FormData(form).entries()); const msgEl=form.querySelector('#submitToolFormMessage'); const btn=form.querySelector('button[type="submit"]'); const token=localStorage.getItem('authToken'); if(!msgEl || !btn) return; if (!data.name||!data.website_url||!data.category_slug||!data.description){msgEl.textContent='Please fill all required fields (*).';msgEl.className='text-sm mb-3 text-red-600';return;}
                // Basic URL validation
                 try { new URL(data.website_url); } catch (_) { msgEl.textContent = 'Please enter a valid Website URL (e.g., https://example.com).'; msgEl.className = 'text-sm mb-3 text-red-600'; return; }

                btn.disabled=true;btn.innerHTML='<i class="fas fa-spinner fa-spin mr-2"></i> Submitting...';msgEl.textContent='';
                try{const res=await fetch(`${API_BASE_URL}/tools/submit`,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${token}`},body:JSON.stringify(data)});const result=await res.json();if(!res.ok)throw new Error(result.error||`Server Error: ${res.statusText} (${res.status})`);msgEl.textContent=result.message||'Submission successful! Thank you for your contribution.';msgEl.className='text-sm mb-3 text-green-600';form.reset();showTemporaryMessage('Tool submitted for review!', 'success'); setTimeout(()=>closeModalById('submitToolModal'),2500);}catch(error){console.error("Tool submit error:",error);msgEl.textContent=`Error: ${escapeHTML(error.message)}`;msgEl.className='text-sm mb-3 text-red-600';if(String(error.message).includes('401')||String(error.message).includes('403')||String(error.message).includes('Unauthorized'))handleLogout();}finally{btn.disabled=false;btn.innerHTML='Submit for Review';}
            }

            // ==================================================
            // == SCROLLING & NAVIGATION
            // ==================================================
            function setupSmoothScrolling(){document.querySelectorAll('.nav-link').forEach(a=>{a.addEventListener('click',(e)=>{const h=e.currentTarget.getAttribute('href');if(h?.startsWith('#')){e.preventDefault();const t=document.querySelector(h);if(t){closeMobileMenu();scrollToElement(t);updateActiveNavLinkByTargetId(h);}}});});}
            function scrollToElement(el){if(!el)return;const navH=document.querySelector('nav')?.offsetHeight||0;const pos=el.getBoundingClientRect().top;const off=pos+window.pageYOffset-navH - 16; /* Extra offset */ window.scrollTo({top:off,behavior:"smooth"});}
            function setupScrollspy(){const secs=document.querySelectorAll('section[id]');const links=document.querySelectorAll('.nav-link[href^="#"]');if(!secs.length||!links.length)return;const obs=new IntersectionObserver((entries)=>{let bestId=null;let bestRatio = 0; entries.forEach(e=>{if(e.isIntersecting && e.intersectionRatio >= bestRatio){bestRatio = e.intersectionRatio; bestId=e.target.getAttribute('id');}}); if(bestId)updateActiveNavLinkByTargetId(`#${bestId}`);},{rootMargin:'-80px 0px -50% 0px',threshold:[0, 0.5, 1]});secs.forEach(s=>obs.observe(s));} // Adjusted rootMargin
            function updateActiveNavLinkByTargetId(targetHref){document.querySelectorAll('nav .hidden.sm\\:flex .nav-link').forEach(l=>{const a=l.getAttribute('href')===targetHref;l.classList.toggle('border-indigo-500',a);l.classList.toggle('text-gray-900',a);l.classList.toggle('border-transparent',!a);l.classList.toggle('text-gray-500',!a);});document.querySelectorAll('#mobile-menu .nav-link').forEach(l=>{const a=l.getAttribute('href')===targetHref;l.classList.toggle('border-indigo-500',a);l.classList.toggle('text-indigo-700',a);l.classList.toggle('bg-indigo-50',a);l.classList.toggle('border-transparent',!a);l.classList.toggle('text-gray-500',!a);});}

            // ==================================================
            // == OTHER UI SETUP
            // ==================================================
            function setupMobileMenu(){mobileMenuBtn?.addEventListener('click',toggleMobileMenu);}
            function toggleMobileMenu(){mobileMenu?.classList.toggle('hidden');const i=mobileMenuBtn?.querySelector('i');if(i)i.classList.toggle('fa-bars')||i.classList.toggle('fa-times');}
            function closeMobileMenu(){mobileMenu?.classList.add('hidden');const i=mobileMenuBtn?.querySelector('i');if(i?.classList.contains('fa-times'))i.classList.replace('fa-times','fa-bars');}
            function initializeStatsAnimation(){const sec=document.querySelector('.bg-indigo-800');if(!sec||typeof IntersectionObserver==='undefined'){document.querySelectorAll('.bg-indigo-700 .text-4xl[data-target]').forEach(s=>{const t=parseInt(s.dataset.target,10);if(!isNaN(t))s.textContent=t.toLocaleString()+(s.textContent.includes('+')?'+':'');});return;} const obs=new IntersectionObserver((entries,o)=>{entries.forEach(e=>{if(e.isIntersecting){animateStatsNumbers();o.unobserve(e.target);}});},{threshold:0.1}); obs.observe(sec);}
            function animateStatsNumbers(){document.querySelectorAll('.bg-indigo-700 .text-4xl[data-target]').forEach(s=>{const t=parseInt(s.dataset.target,10);if(isNaN(t)||s.dataset.animated)return;s.dataset.animated=true;let c=0;const dur=1500;const inc=Math.max(1,Math.ceil(t/(dur/16)));const update=()=>{c+=inc;if(c<t){s.textContent=Math.min(c,t).toLocaleString()+(s.textContent.includes('+')?'+':'');requestAnimationFrame(update);}else{s.textContent=t.toLocaleString()+(s.textContent.includes('+')?'+':'');}};s.textContent='0'+(s.textContent.includes('+')?'+':'');requestAnimationFrame(update);});}
            function setupHeroCategorySelect(){heroCategorySelect?.addEventListener('change',(e)=>{const sel=e.target.value;const cont=document.querySelector('#home .space-y-4');if(!cont)return;cont.querySelectorAll('.tool-card').forEach(card=>{const p=card.querySelector('p.text-sm.text-gray-500');const txt=p?p.textContent.trim().toLowerCase():'';let match=false;if(sel==='All Categories')match=true;else if(sel==='Text Generation'&&(txt.includes('text')||txt.includes('reasoning')))match=true;else if(sel==='Image Generation'&&txt.includes('image'))match=true;else if(sel==='Code Assistants'&&txt.includes('code'))match=true;else if(sel==='Audio & Music'&&(txt.includes('music')||txt.includes('audio')))match=true;card.style.transition='opacity 0.3s ease, transform 0.3s ease';card.style.pointerEvents = match ? '' : 'none'; card.style.opacity = match ? '1' : '0.5'; card.style.transform = match ? 'scale(1)' : 'scale(0.98)';});});}
            function setupStarRatingInput() { const container = modalBody?.querySelector('.star-rating-input'); if (!container) return; const stars = container.querySelectorAll('label'); const setRating = (ratingVal) => { container.dataset.ratingValue = ratingVal; stars.forEach((lbl, idx) => { const starVal = 5 - idx; const icon = lbl.querySelector('i'); if (icon) { icon.classList.toggle('fas', starVal <= ratingVal); icon.classList.toggle('far', starVal > ratingVal); icon.classList.toggle('text-yellow-400', starVal <= ratingVal); icon.classList.toggle('text-gray-300', starVal > ratingVal); } }); }; stars.forEach(label => { const rating = parseInt(label.previousElementSibling.value, 10); label.addEventListener('mouseover', () => { stars.forEach((hoverLbl, idx) => { const hoverVal = 5 - idx; const icon = hoverLbl.querySelector('i'); if (icon) { icon.classList.toggle('text-yellow-400', hoverVal <= rating); icon.classList.toggle('text-gray-300', hoverVal > rating); } }); }); label.addEventListener('mouseout', () => { setRating(parseInt(container.dataset.ratingValue, 10)); }); label.addEventListener('click', () => { setRating(rating); const radio = document.getElementById(`star${rating}`); if (radio) radio.checked = true; }); }); setRating(parseInt(container.dataset.ratingValue, 10)); }

            // ==================================================
            // == INITIAL SETUP FUNCTION
            // ==================================================
            async function setupAndLoad() {
                console.log("Initializing setup...");
                // 1. Load persisted state
                const savedFilters = loadFiltersFromLocalStorage();
                applySavedFiltersToUI(savedFilters); // Apply filters to UI controls
                loadComparisonFromLocalStorage(); // Load comparison tray state

                // 2. Check auth state & Fetch user-specific data
                if (localStorage.getItem('authToken')) {
                    await fetchUserFavorites(); // Fetch favs if logged in
                } else {
                    userFavorites.clear(); // Ensure favs are clear if not logged in
                }

                // 3. Update UI based on initial auth state
                updateAuthUI(); // Update navbar, show/hide buttons etc.

                // 4. Fetch initial page content (tools & news) using potentially saved filters
                await fetchAndRenderInitialData(); // This uses getCurrentFilters() which reads from UI

                // 5. Setup remaining UI event listeners AFTER initial render & auth check
                setupModal();
                setupSmoothScrolling();
                setupMobileMenu();
                setupFilterSortListeners(); // Setup tool & news filter/sort listeners
                initializeStatsAnimation();
                setupMatchmakerForm();
                setupNewsGridDelegation(); // Handles clicks inside news grid
                setupHeroCategorySelect();
                setupComparisonTray(); // Sets up tray button listeners
                setupLoadMoreButtons();
                setupSubmitToolModal(); // Sets up listener for the "Submit Tool" button
                setupScrollspy(); // For highlighting nav links on scroll
                // setupFavoriteButtonListener(); // Favorite listeners are now attached dynamically via attach...CardEvents

                console.log("AI Tools Directory Frontend Initialized");
            }

            // ==================================================
            // == START EXECUTION
            // ==================================================
            await setupAndLoad(); // Run the main setup function

        }); // --- END DOMContentLoaded ---
     </script>
 </body>
 </html>
